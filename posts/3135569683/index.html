<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.2.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-my.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-my.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"crystal1213.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="本文主要讲述 Redis 基础。">
<meta property="og:type" content="article">
<meta property="og:title" content="Redis">
<meta property="og:url" content="https://crystal1213.github.io/posts/3135569683/index.html">
<meta property="og:site_name" content="Crystal_Blog">
<meta property="og:description" content="本文主要讲述 Redis 基础。">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://i.loli.net/2021/04/19/Ti7JKVoRYId4P9M.png">
<meta property="og:image" content="https://i.loli.net/2021/04/19/9F2eEcklULxnfRO.png">
<meta property="og:image" content="https://i.loli.net/2021/04/19/PbHNQ5yShj1pfkv.png">
<meta property="og:image" content="https://i.loli.net/2021/04/19/OrWTsn1SGj9LBHt.png">
<meta property="og:image" content="https://i.loli.net/2021/04/20/F61xmTRZpOb5zgL.png">
<meta property="og:image" content="https://i.loli.net/2021/04/20/XuFcil3AZ6LB9R1.png">
<meta property="og:image" content="https://i.loli.net/2021/04/20/5SQO14AB7a8GWmK.png">
<meta property="og:image" content="https://i.loli.net/2021/04/20/sLzKCWyXcSNZml2.png">
<meta property="og:image" content="https://i.loli.net/2021/04/20/SUHTW5jsGDL7Ce1.png">
<meta property="og:image" content="https://i.loli.net/2021/04/20/JMwsixEH7tVpRcr.png">
<meta property="og:image" content="https://i.loli.net/2021/04/20/2WrAC7cUPBHzV1Y.png">
<meta property="og:image" content="https://i.loli.net/2021/04/20/OHCUIeXV1afDEhv.png">
<meta property="og:image" content="https://i.loli.net/2021/04/20/rhBRDnUl5wkzexS.png">
<meta property="og:image" content="https://i.loli.net/2021/04/20/EdFh8Pg4UNkIziM.png">
<meta property="og:image" content="https://i.loli.net/2021/04/20/LYOJwc7KgidSyqn.png">
<meta property="og:image" content="https://i.loli.net/2021/04/20/lFscjdHpQyOt7UJ.png">
<meta property="og:image" content="https://i.loli.net/2021/04/21/pWdPM2mBOYaso8X.png">
<meta property="og:image" content="https://i.loli.net/2021/04/21/gVjmZJQOhSuPaL8.png">
<meta property="og:image" content="https://i.loli.net/2021/04/23/PMt67xdTgbeyk3h.png">
<meta property="og:image" content="https://i.loli.net/2021/04/23/Fiu8DqYRzrywnZe.png">
<meta property="og:image" content="https://i.loli.net/2021/04/23/VmZGbXuB7hvidMK.png">
<meta property="og:image" content="https://i.loli.net/2021/04/25/DdTH6tMYb9Kh1sC.png">
<meta property="og:image" content="https://i.loli.net/2021/04/25/FZtpChAiuTRaYmG.png">
<meta property="og:image" content="https://i.loli.net/2021/04/25/yX7OG5AsDrmewkF.png">
<meta property="og:image" content="https://i.loli.net/2021/04/25/Fw1cg8PlCL3tiWR.png">
<meta property="og:image" content="https://i.loli.net/2021/04/25/qcR6WSdtl1LFvTN.png">
<meta property="og:image" content="https://i.loli.net/2021/04/25/EKsQoBLCG4jxRHm.png">
<meta property="og:image" content="https://i.loli.net/2021/04/25/zIxSKhognMC3alp.png">
<meta property="og:image" content="https://i.loli.net/2021/04/25/c1jGq4KmeavEhBC.png">
<meta property="og:image" content="https://i.loli.net/2021/04/26/2WhANLuRG13q9Pd.png">
<meta property="og:image" content="https://i.loli.net/2021/04/26/yiJ5CWz4rRlm8XV.png">
<meta property="og:image" content="https://i.loli.net/2021/04/26/dpxraqhWR5HmwBi.png">
<meta property="og:image" content="https://i.loli.net/2021/04/26/1XohJvDHYaIurki.png">
<meta property="og:image" content="https://i.loli.net/2021/04/26/zWGJmus7f3AZFBT.png">
<meta property="og:image" content="https://i.loli.net/2021/04/26/VN4Blt3hCLaKPmv.png">
<meta property="og:image" content="https://i.loli.net/2021/04/26/rDl7EjiHf83G9TZ.png">
<meta property="og:image" content="https://i.loli.net/2021/04/26/EXezYsmndO63chR.png">
<meta property="og:image" content="https://i.loli.net/2021/04/26/sDvWVMuSP3L5TFZ.png">
<meta property="og:image" content="https://i.loli.net/2021/04/26/Bb6f9d2VUiXG8Ar.png">
<meta property="article:published_time" content="2021-04-19T08:49:32.000Z">
<meta property="article:modified_time" content="2021-04-26T08:47:05.888Z">
<meta property="article:author" content="Crystal">
<meta property="article:tag" content="C++ python">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://i.loli.net/2021/04/19/Ti7JKVoRYId4P9M.png">

<link rel="canonical" href="https://crystal1213.github.io/posts/3135569683/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Redis | Crystal_Blog</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="Crystal_Blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Crystal_Blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">On the way, there will be more possibilities in the future.</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">15</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">5</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">23</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://crystal1213.github.io/posts/3135569683/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.gif">
      <meta itemprop="name" content="Crystal">
      <meta itemprop="description" content="Guard heart, everything flows from it.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Crystal_Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Redis
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-04-19 16:49:32" itemprop="dateCreated datePublished" datetime="2021-04-19T16:49:32+08:00">2021-04-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2021-04-26 16:47:05" itemprop="dateModified" datetime="2021-04-26T16:47:05+08:00">2021-04-26</time>
              </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>54k</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>本文主要讲述 Redis 基础。</p>
<a id="more"></a>


<h2 id="1-Nosql-概述"><a href="#1-Nosql-概述" class="headerlink" title="1 Nosql 概述"></a>1 Nosql 概述</h2><h3 id="1-1-为什么要用-Nosql"><a href="#1-1-为什么要用-Nosql" class="headerlink" title="1.1 为什么要用 Nosql"></a>1.1 为什么要用 Nosql</h3><blockquote>
<ol>
<li>单机 MySQL 时代<br><img src="https://i.loli.net/2021/04/19/Ti7JKVoRYId4P9M.png" alt="image.png"><br>90 年代，更多使用静态网页 Html，服务器根本没什么压力；一个基本的网站访问量一般也不会太大，单个数据库足够！<br>这种情况下，网站的瓶颈：</li>
</ol>
</blockquote>
<ol>
<li>数据量如果太大，一个机器放不下！</li>
<li>数据的索引（B+ Tree），一个机器内存也放不下</li>
<li>访问量（读写混合），一个服务器承受不了</li>
</ol>
<blockquote>
<ol start="2">
<li>Memcached（缓存）+ MySQL + 垂直拆分（读写分离）</li>
</ol>
</blockquote>
<p>网站 80% 的情况都是在读，每次都要去查询数据库就十分麻烦，所以说我们希望减轻数据的压力，可以使用缓存来保证效率！</p>
<p>发展过程：优化数据结构和索引–&gt;文件缓存（IO）–&gt;Memcached（当时最热门的技术！）</p>
<p><img src="https://i.loli.net/2021/04/19/9F2eEcklULxnfRO.png" alt="image.png"></p>
<blockquote>
<ol start="3">
<li>分库分表 + 水平拆分 + MySQL 集群</li>
</ol>
</blockquote>
<p>本质：数据库的读和写<br>发展过程：</p>
<ul>
<li>早期 MySQL 的引擎 MyISAM：表锁，十分影响效率，高并发下就会出现严重的锁问题</li>
<li>后来 MySQL 的引擎 Innodb: 行锁</li>
<li>慢慢的就开始使用分库分表：来解决写的压力，MySQL 在那个年代推出了表分区，但是并没有多少公司使用。</li>
<li>MySQL 集群：很好满足那个年代的所有需求</li>
</ul>
<p><img src="https://i.loli.net/2021/04/19/PbHNQ5yShj1pfkv.png" alt="image.png"></p>
<blockquote>
<ol start="4">
<li>如今的年代</li>
</ol>
</blockquote>
<p>MySQL 会用来存储比较大的文件，博客、图片等等，数据库表 很大，效率就低了，如果有一种数据库来专门处理这种数据，MySQL 压力就变得十分小。</p>
<p>目前的一个基本的互联网项目：<br><img src="https://i.loli.net/2021/04/19/OrWTsn1SGj9LBHt.png" alt="image.png"></p>
<blockquote>
<p>为什么要用 NoSQL?<br>NoSQL 能够很好的处理用户的个人信息、社交网络、地理位置等信息，而且当今用户自己产生的数据、用户日志爆发式增长！</p>
</blockquote>
<h3 id="1-2-什么是-NoSQL"><a href="#1-2-什么是-NoSQL" class="headerlink" title="1.2 什么是 NoSQL"></a>1.2 什么是 NoSQL</h3><p>NoSQL = Not Only SQL （不仅仅是 SQL）</p>
<p>关系型数据库：表格、行、列</p>
<p>传统的关系型数据库很难对付 web2.0 时代，随着 web2.0 时代的诞生，尤其是超大规模的高并发社区，暴露出来很难克服的问题，Nosql 发展十分迅速，是必须掌握的技术。</p>
<p>很多数据类型，例如：用户的个人信息、社交网络、地理位置，这些数据类型的存储不需要一个固定的格式，不需要很多操作就可以横向扩展。</p>
<blockquote>
<p>NoSQL 特点</p>
</blockquote>
<ol>
<li>方便扩展（数据之间没有关系，很好扩展！）</li>
<li>大数据量高性能（Redis 一秒写 8 万次，读取 11 万次，NoSQL 的缓存记录级，是一种细粒度的缓存，性能会比较高！）</li>
<li>数据类型是多样型的！（不需要实现设计书库！随取随用，如果是数据量十分大的表，很多人就无法设计了。）</li>
<li>传统的 RDBMS 和 NoSQL：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">传统的RDBMS：</span><br><span class="line">- 结构化组织</span><br><span class="line">- SQL</span><br><span class="line">- 数据和关系都存在单独的表中，表有行有列</span><br><span class="line">- 数据库操作：数据定义语言</span><br><span class="line">- 严格的一致性</span><br><span class="line">- 基础的事物</span><br><span class="line">- ...</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Nosql:</span><br><span class="line">- 不仅仅是数据</span><br><span class="line">- 没有固定的查询语言</span><br><span class="line">- 键值对存储，列存储，文档存储，图形数据库（社交关系）</span><br><span class="line">- 最终一致性</span><br><span class="line">- CAP 定理 和 BASE</span><br><span class="line">- 高性能，高可用，高可扩</span><br></pre></td></tr></table></figure>

<blockquote>
<p>了解：大数据时代的 3V 和 3高</p>
</blockquote>
<p>大数据时代的 3V：主要是描述问题的</p>
<ol>
<li>海量：Volume</li>
<li>多样：Variety</li>
<li>实时：Velocity</li>
</ol>
<p>大数据时代的 3高：主要对程序的需求</p>
<ol>
<li>高并发</li>
<li>高可扩</li>
<li>高性能</li>
</ol>
<p>真正在公司中的实践：NoSQL + RDBMS 结合使用</p>
<h3 id="1-3-阿里巴巴演进分析"><a href="#1-3-阿里巴巴演进分析" class="headerlink" title="1.3 阿里巴巴演进分析"></a>1.3 阿里巴巴演进分析</h3><p><img src="https://i.loli.net/2021/04/20/F61xmTRZpOb5zgL.png" alt="image.png"></p>
<p>如果你未来相当架构师：没有什么是加一层解决不了的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 商品的基本信息</span></span><br><span class="line">名称、价格、商家信息：关系型数据库就可以解决，MySQL、Oracle</span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 商品的描述、评论（文字比较多）</span></span><br><span class="line">文档型数据库：MongoDB</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3. 图片</span></span><br><span class="line">分布式文件系统 FastDFS</span><br><span class="line">- 淘宝自己的：TFS</span><br><span class="line">- 谷歌的：GFS</span><br><span class="line">- Hadoop：HADFS</span><br><span class="line">- 阿里云的：OSS</span><br><span class="line"></span><br><span class="line"><span class="comment"># 4. 商品的关键字（搜索）</span></span><br><span class="line">- 搜索引擎 solr、elasticsearch</span><br><span class="line">- ISearch（淘宝：多隆）</span><br><span class="line"></span><br><span class="line"><span class="comment"># 5. 商品热门的波段信息</span></span><br><span class="line">- 内存数据库</span><br><span class="line">- Redis、Tair、Memache、...</span><br><span class="line"></span><br><span class="line"><span class="comment"># 6. 商品的交易，外部的支付接口</span></span><br><span class="line">- 三方应用</span><br></pre></td></tr></table></figure>

<p>一个简单的网页背后的技术一定不是大家想的那么简单，大型互联网应用问题：</p>
<ul>
<li>数据类型太多</li>
<li>数据源繁多、经常重构</li>
<li>数据要改造，大面积改造</li>
</ul>
<p>解决方法：<br><img src="https://i.loli.net/2021/04/20/XuFcil3AZ6LB9R1.png" alt="image.png"><br><img src="https://i.loli.net/2021/04/20/5SQO14AB7a8GWmK.png" alt="image.png"></p>
<h3 id="1-4-NoSQL-四大分类"><a href="#1-4-NoSQL-四大分类" class="headerlink" title="1.4 NoSQL 四大分类"></a>1.4 NoSQL 四大分类</h3><p><strong>KV 键值对：</strong></p>
<ul>
<li>新浪：<strong>Redis</strong></li>
<li>美团：Redis + Tair</li>
<li>阿里、百度：Redis + memecache</li>
</ul>
<p><strong>文档型数据库（bson 格式和 json 一样）：</strong></p>
<ul>
<li><strong>MongoDB</strong> （一般必须掌握）<ul>
<li>MongoDB 是一个基于分布式文件存储的数据库，C++ 编写，主要用来处理大量的文档</li>
<li>MongoDB 是一个介于关系型数据库和非关系型数据库中间的产品，MongoDB 是非关系型数据库中功能最丰富，最像关系型数据库的。</li>
</ul>
</li>
<li>CouchDB</li>
</ul>
<p><strong>列存储数据库：</strong></p>
<ul>
<li><strong>HBase</strong></li>
<li>分布式文件系统</li>
</ul>
<p><strong>图关系数据库：</strong><br><img src="https://i.loli.net/2021/04/20/sLzKCWyXcSNZml2.png" alt="image.png"></p>
<ul>
<li>他不是存图形，放的是关系，例如：朋友圈的社交网络、广告推荐</li>
<li><strong>Neoj4</strong> ，InfoGrid</li>
</ul>
<p><strong>四者对比：</strong><br><img src="https://i.loli.net/2021/04/20/SUHTW5jsGDL7Ce1.png" alt="image.png"></p>
<h2 id="2-Redis-入门"><a href="#2-Redis-入门" class="headerlink" title="2 Redis 入门"></a>2 Redis 入门</h2><h3 id="2-1-概述"><a href="#2-1-概述" class="headerlink" title="2.1 概述"></a>2.1 概述</h3><blockquote>
<p>Redis 是什么？</p>
</blockquote>
<p>Redis(Remote Dictionary Server) 远程字典服务，是一个开源的使用 ANSI C 编写、支持网络、可基于内存亦可持久化的日志型、Key-Value数据库，并提供多种语言的 API。<br><img src="https://i.loli.net/2021/04/20/JMwsixEH7tVpRcr.png" alt="image.png"></p>
<p>Redis 会周期性的把更新的数据写入磁盘或者把修改操作写入追加的记录文件，并在此基础上实现 master-slave（主从）同步。</p>
<ul>
<li>免费和开源</li>
<li>当下最热门的 NoSQL 技术之一，也被人们称之为结构化数据库</li>
</ul>
<blockquote>
<p>Redis 能干嘛？</p>
</blockquote>
<ol>
<li>内存存储、持久化，内存中是断电即失、所以说持久化很重要（rdb、aof）</li>
<li>效率高，可用于高速缓存</li>
<li>发布订阅系统</li>
<li>地图分析</li>
<li>计时器、计数器</li>
<li>…</li>
</ol>
<blockquote>
<p>特性</p>
</blockquote>
<ol>
<li>多样的数据类型</li>
<li>持久化</li>
<li>集群</li>
<li>事务</li>
<li>…</li>
</ol>
<blockquote>
<p>学习中需要用到的东西</p>
</blockquote>
<ol>
<li>官网：<a target="_blank" rel="noopener" href="https://redis.io/">https://redis.io/</a></li>
<li>中文官网：<a target="_blank" rel="noopener" href="http://www.redis.cn/">http://www.redis.cn/</a>   <a target="_blank" rel="noopener" href="https://www.redis.net.cn/">https://www.redis.net.cn/</a></li>
</ol>
<h3 id="2-2-Linux-安装"><a href="#2-2-Linux-安装" class="headerlink" title="2.2 Linux 安装"></a>2.2 Linux 安装</h3><ol>
<li>下载安装包，在官网 <a target="_blank" rel="noopener" href="https://redis.io/">https://redis.io/</a> 下载，下载好压缩包后，使用 <code>rz</code> 命令上传到 Linux 系统的 /home/package_yyf 下</li>
</ol>
<p><img src="https://i.loli.net/2021/04/20/2WrAC7cUPBHzV1Y.png" alt="image.png"></p>
<ol start="2">
<li>将 redis-6.2.2.tar.gz 压缩包 移动到 /opt 文件夹下，并在该文件夹下解压，解压后可看到 redis 配置文件</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mv redis-6.2.2.tar.gz /opt</span><br><span class="line">cd /opt</span><br><span class="line">tar -zxvf redis-6.2.2.tar.gz</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>基本的环境安装</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install gcc-c++</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>redis 默认安装路径 /usr/local/bin</li>
<li>将 redis 配置文件复制到安装路径下，在 /usr/local/bin 目录下新建一个文件夹 yyfconfig ，将 redis.conf 文件拷贝到新建的文件夹下，之后就可以使用这个配置文件启动</li>
<li>redis 默认不是后台启动的，需要将 redis.conf 配置文件中的 <code>daemonize</code> 后的内容改为 <code>yes</code>，保存文件，然后退出</li>
<li>启动 redis 服务，执行命令：<code>redis-server yyfconfig/redis.conf</code></li>
<li>使用客户端 redis-cli 进行测试连接，执行命令 <code>redis-cli -p 6379</code></li>
</ol>
<p><img src="https://i.loli.net/2021/04/20/OHCUIeXV1afDEhv.png" alt="image.png"></p>
<ol start="9">
<li><p>可以在另一个窗口查看 redis 进程，执行命令 <code>ps -ef|grep redis</code></p>
</li>
<li><p>关闭 redis 服务，执行命令 <code>shutdown</code>，退出：<code>exit</code></p>
</li>
</ol>
<h3 id="2-3-测试性能"><a href="#2-3-测试性能" class="headerlink" title="2.3 测试性能"></a>2.3 测试性能</h3><p>/usr/local/bin 目录下的 redis-benchmark 用来测试性能</p>
<ol>
<li>首先启动 redis 服务：<code>redis-server yyfconfig/redis.conf</code></li>
<li>测试是否启动成功：<code>redis-cli -p 6379</code> 再执行 <code>ping</code></li>
<li>接下来执行 redis-benchmark 命令，该命令相关的参数如下：</li>
</ol>
<p><img src="https://i.loli.net/2021/04/20/rhBRDnUl5wkzexS.png" alt="image.png"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 测试：100 个并发连接 100000 个请求</span></span><br><span class="line">redis-benchmark -h localhost -p 6379 -c 100 -n 100000</span><br><span class="line"></span><br><span class="line">[root@test1 package_yyf]# redis-benchmark -h localhost -p 6379 -c 100 -n 100000</span><br><span class="line">====== PING_INLINE ======                                                   </span><br><span class="line">  100000 requests completed in 5.28 seconds</span><br><span class="line">  100 parallel clients</span><br><span class="line">  3 bytes payload</span><br><span class="line">  keep alive: 1</span><br><span class="line">  host configuration &quot;save&quot;: 3600 1 300 100 60 10000</span><br><span class="line">  host configuration &quot;appendonly&quot;: no</span><br><span class="line">  multi-thread: no</span><br><span class="line"></span><br><span class="line">Latency by percentile distribution:</span><br><span class="line">0.000% &lt;= 2.015 milliseconds (cumulative count 6)</span><br><span class="line">50.000% &lt;= 3.679 milliseconds (cumulative count 50030)</span><br><span class="line">75.000% &lt;= 4.391 milliseconds (cumulative count 75112)</span><br><span class="line">87.500% &lt;= 4.759 milliseconds (cumulative count 87724)</span><br><span class="line">93.750% &lt;= 5.183 milliseconds (cumulative count 93798)</span><br><span class="line">96.875% &lt;= 5.911 milliseconds (cumulative count 96875)</span><br><span class="line">98.438% &lt;= 6.943 milliseconds (cumulative count 98446)</span><br><span class="line">99.219% &lt;= 8.071 milliseconds (cumulative count 99220)</span><br><span class="line">99.609% &lt;= 9.383 milliseconds (cumulative count 99611)</span><br><span class="line">99.805% &lt;= 11.807 milliseconds (cumulative count 99805)</span><br><span class="line">99.902% &lt;= 14.039 milliseconds (cumulative count 99903)</span><br><span class="line">99.951% &lt;= 22.991 milliseconds (cumulative count 99952)</span><br><span class="line">99.976% &lt;= 24.383 milliseconds (cumulative count 99976)</span><br><span class="line">99.988% &lt;= 25.023 milliseconds (cumulative count 99988)</span><br><span class="line">99.994% &lt;= 25.439 milliseconds (cumulative count 99994)</span><br><span class="line">99.997% &lt;= 25.679 milliseconds (cumulative count 99997)</span><br><span class="line">99.998% &lt;= 25.871 milliseconds (cumulative count 99999)</span><br><span class="line">99.999% &lt;= 25.999 milliseconds (cumulative count 100000)</span><br><span class="line">100.000% &lt;= 25.999 milliseconds (cumulative count 100000)</span><br><span class="line"></span><br><span class="line">Cumulative distribution of latencies:</span><br><span class="line">0.000% &lt;= 0.103 milliseconds (cumulative count 0)</span><br><span class="line">0.441% &lt;= 2.103 milliseconds (cumulative count 441)</span><br><span class="line">30.074% &lt;= 3.103 milliseconds (cumulative count 30074)</span><br><span class="line">64.996% &lt;= 4.103 milliseconds (cumulative count 64996)</span><br><span class="line">93.118% &lt;= 5.103 milliseconds (cumulative count 93118)</span><br><span class="line">97.273% &lt;= 6.103 milliseconds (cumulative count 97273)</span><br><span class="line">98.590% &lt;= 7.103 milliseconds (cumulative count 98590)</span><br><span class="line">99.237% &lt;= 8.103 milliseconds (cumulative count 99237)</span><br><span class="line">99.559% &lt;= 9.103 milliseconds (cumulative count 99559)</span><br><span class="line">99.702% &lt;= 10.103 milliseconds (cumulative count 99702)</span><br><span class="line">99.767% &lt;= 11.103 milliseconds (cumulative count 99767)</span><br><span class="line">99.819% &lt;= 12.103 milliseconds (cumulative count 99819)</span><br><span class="line">99.881% &lt;= 13.103 milliseconds (cumulative count 99881)</span><br><span class="line">99.904% &lt;= 14.103 milliseconds (cumulative count 99904)</span><br><span class="line">99.912% &lt;= 15.103 milliseconds (cumulative count 99912)</span><br><span class="line">99.913% &lt;= 16.103 milliseconds (cumulative count 99913)</span><br><span class="line">99.917% &lt;= 18.111 milliseconds (cumulative count 99917)</span><br><span class="line">99.926% &lt;= 19.103 milliseconds (cumulative count 99926)</span><br><span class="line">99.934% &lt;= 22.111 milliseconds (cumulative count 99934)</span><br><span class="line">99.954% &lt;= 23.103 milliseconds (cumulative count 99954)</span><br><span class="line">99.972% &lt;= 24.111 milliseconds (cumulative count 99972)</span><br><span class="line">99.989% &lt;= 25.103 milliseconds (cumulative count 99989)</span><br><span class="line">100.000% &lt;= 26.111 milliseconds (cumulative count 100000)</span><br><span class="line"></span><br><span class="line">Summary:</span><br><span class="line">  throughput summary: 18925.06 requests per second</span><br><span class="line">  latency summary (msec):</span><br><span class="line">          avg       min       p50       p95       p99       max</span><br><span class="line">        3.775     2.008     3.679     5.375     7.671    25.999</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>上述显示内容的含义：<br><img src="https://i.loli.net/2021/04/20/EdFh8Pg4UNkIziM.png" alt="image.png"></p>
<h3 id="2-4-基础知识"><a href="#2-4-基础知识" class="headerlink" title="2.4 基础知识"></a>2.4 基础知识</h3><p>redis 默认有 16 个数据库，可通过查看其安装目录下的配置文件 /usr/local/bin/yyfconfig/redis.conf 获知。默认是在第 0 个数据库下。<br><img src="https://i.loli.net/2021/04/20/LYOJwc7KgidSyqn.png" alt="image.png"></p>
<p>一些操作 redis 数据库的命令：</p>
<ul>
<li>切换数据库：<code>select num</code> （num 是数据库的编号，例如：<code>select 5</code>）</li>
<li>查看当前数据库大小的命令：<code>dbsize</code></li>
<li>查看当前数据库全部键的命令：<code>keys *</code></li>
<li>在当前数据库下创建键值对：<code>set 键 值</code> （例如：<code>set name yyf</code>）</li>
<li>获取当前数据库下键对应的值：<code>get 键</code> （例如：<code>get name</code>）</li>
<li>清除当前数据库的命令：<code>flushdb</code></li>
<li>清除全部数据库的内容：<code>flushall</code><br><img src="https://i.loli.net/2021/04/20/lFscjdHpQyOt7UJ.png" alt="image.png"></li>
</ul>
<p>思考：为什么 redis 的端口号是 6379？===&gt; 粉丝效应（一位女明星的名字对应的数字）</p>
<blockquote>
<p>Redis 是单线程的</p>
</blockquote>
<p>Redis 是很快的，官方表示：Redis 是基于内存操作，CPU 不是 Redis 性能的瓶颈，Redis 性能的瓶颈是根据的内存和网络带宽，使用单线程来就可以达到较高的读写速度。</p>
<p>Redis 是 C 语言写的，官方提供的数据为 100000+ 的 QPS，完全不比同样使用 key-value 的 Memecache 差。</p>
<p><strong>Q:Redis 为什么单线程还这么快？</strong></p>
<ol>
<li>误区1：高性能的服务器一定是多线程的？</li>
<li>误区2：多线程（CPU 会进行上下文切换）一定比单线程效率高？</li>
<li>要了解读写速度：CPU &gt; 内存 &gt; 硬盘<br>核心：redis 是将所有的数据全部放在内存中的，所以说使用单线程去操作效率就是最高的，多线程中 CPU 上下文的切换会耗时。对于内存系统来说，如果没有上下文切换，效率就是最高的，因为多次读写都是在一个 CPU 上。</li>
</ol>
<h2 id="3-五大数据类型"><a href="#3-五大数据类型" class="headerlink" title="3 五大数据类型"></a>3 五大数据类型</h2><p>中文官网对 redis 的介绍：Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作<strong>数据库、缓存和消息中间件</strong> 。 它支持多种类型的数据结构，如 字符串（strings）， 散列（hashes）， 列表（lists）， 集合（sets）， 有序集合（sorted sets） 与范围查询， bitmaps， hyperloglogs 和 地理空间（geospatial） 索引半径查询。 Redis 内置了 复制（replication），LUA脚本（Lua scripting）， LRU驱动事件（LRU eviction），事务（transactions） 和不同级别的 磁盘持久化（persistence）， 并通过 Redis哨兵（Sentinel）和自动 分区（Cluster）提供高可用性（high availability）。</p>
<h3 id="3-1-Redis-Key"><a href="#3-1-Redis-Key" class="headerlink" title="3.1 Redis-Key"></a>3.1 Redis-Key</h3><p>一些命令：</p>
<ul>
<li>查看键所对应的值的数据类型：<code>type 键</code></li>
<li>移除键值对：<code>move 键 数据库编号</code> </li>
<li>设置键的生存时间：<code>expire 键 秒数</code></li>
<li>查看键的生存时间还剩几秒：<code>ttl 键</code></li>
<li>查看一个键是否存在：<code>exists 键</code></li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line">127.0.0.1:6379&gt; flushall</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set name yyf</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">&quot;yyf&quot;</span><br><span class="line">127.0.0.1:6379&gt; set age 23</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get age</span><br><span class="line">&quot;23&quot;</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;name&quot;</span><br><span class="line">2) &quot;age&quot;</span><br><span class="line">127.0.0.1:6379&gt; type name</span><br><span class="line">string</span><br><span class="line">127.0.0.1:6379&gt; type age</span><br><span class="line">string</span><br><span class="line">127.0.0.1:6379&gt; move age 0</span><br><span class="line">(error) ERR source and destination objects are the same</span><br><span class="line">127.0.0.1:6379&gt; move age 1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; expire name 10</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; ttl name</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; ttl name</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; ttl name</span><br><span class="line">(integer) -2</span><br><span class="line">127.0.0.1:6379&gt; get name</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; exist name</span><br><span class="line">(error) ERR unknown command `exist`, with args beginning with: `name`, </span><br><span class="line">127.0.0.1:6379&gt; exists name</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>

<p>redis 的命令可查看中文官网：<br><img src="https://i.loli.net/2021/04/21/pWdPM2mBOYaso8X.png" alt="image.png"></p>
<h3 id="3-2-string（字符串）"><a href="#3-2-string（字符串）" class="headerlink" title="3.2 string（字符串）"></a>3.2 string（字符串）</h3><ul>
<li>字符串尾部拼接：<code>append 键 拼接的内容</code> （如果键不存在就新建一个）</li>
<li>字符串的长度：<code>strlen 键</code> （得到该键对应的值的长度）</li>
<li>自增1：<code>incr 键</code>（该键对应的值自增1）</li>
<li>自减1：<code>decr 键</code>（该键对应的值自减1）</li>
<li>跨步自增：<code>incrby 键 增加几</code>（该键对应的值自增几）</li>
<li>跨步自减：<code>decrby 键 减少几</code>（该键对应的值自减几）</li>
<li>获取指定范围的字符串：<code>getrange 键 起始下标 结束下标</code> （获得该键的[起始下标：结束下标]对应的字符串）</li>
<li>替换指定范围的字符串：<code>setrange 键 起始下标 替换的字符串</code></li>
<li>创建键值对的时候设定失效的时间：<code>setex 键 失效的秒数 值</code> （set with expire）</li>
<li>如果当前键值对不存在则创景：<code>setnx 键 值</code> （set if not exist）</li>
<li>同时创建多个键值对：<code>mset 键1 值1 [键2 值2 键3 值3 ...]</code></li>
<li>同时获取多个键的值：<code>mget 键1 键2 键3 ...</code></li>
<li>为对象设置键值对：<code>mset user:1:键1 值1 user:1:键2 值2 [user:1:键3 值3 ...]</code></li>
<li>获取对象的键值对：<code>mget user:1:键1 user:1:键2 [user:1:键3 ...]</code></li>
<li>先获取键的值再设定键的值：<code>getset 键 值</code>（如果该键存在，则打印出该键的值然后将该键之前的值更新为新的值；如果不存在，打印 nil 然后再创建该键值对）<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################################################################################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> append</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> strlen</span></span><br><span class="line">127.0.0.1:6379&gt; set key1 v1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get key1 </span><br><span class="line">&quot;v1&quot;</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;key1&quot;</span><br><span class="line">127.0.0.1:6379&gt; exists key1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; append key1 &quot;hello&quot;</span><br><span class="line">(integer) 7</span><br><span class="line">127.0.0.1:6379&gt; get key1</span><br><span class="line">&quot;v1hello&quot;</span><br><span class="line">127.0.0.1:6379&gt; strlen key1</span><br><span class="line">(integer) 7</span><br><span class="line">127.0.0.1:6379&gt; append key1 &quot;yyf&quot;</span><br><span class="line">(integer) 10</span><br><span class="line">127.0.0.1:6379&gt; get key1</span><br><span class="line">&quot;v1helloyyf&quot;</span><br><span class="line">127.0.0.1:6379&gt; type key1</span><br><span class="line">string</span><br><span class="line">127.0.0.1:6379&gt; append key2 v2</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; get key2</span><br><span class="line">&quot;v2&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################################################################################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> incr</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> decr</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> incrby</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> decrby</span></span><br><span class="line">127.0.0.1:6379&gt; set views 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get views</span><br><span class="line">&quot;0&quot;</span><br><span class="line">127.0.0.1:6379&gt; incr views</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; incr views</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; get views</span><br><span class="line">&quot;2&quot;</span><br><span class="line">127.0.0.1:6379&gt; decr views</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; decr views</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; incrby views 10</span><br><span class="line">(integer) 10</span><br><span class="line">127.0.0.1:6379&gt; incrby views 10</span><br><span class="line">(integer) 20</span><br><span class="line">127.0.0.1:6379&gt; decrby views 10</span><br><span class="line">(integer) 10</span><br><span class="line">127.0.0.1:6379&gt; decrby views 10</span><br><span class="line">(integer) 0</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">############################################################################################# getrange</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> setrange</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; set key1 &quot;hello,yyf&quot;</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get key1</span><br><span class="line">&quot;hello,yyf&quot;</span><br><span class="line">127.0.0.1:6379&gt; getrange key1 0 4</span><br><span class="line">&quot;hello&quot;</span><br><span class="line">127.0.0.1:6379&gt; getrange key1 0 -1</span><br><span class="line">&quot;hello,yyf&quot;</span><br><span class="line">127.0.0.1:6379&gt; set key2 &quot;abcdef&quot;</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get key2</span><br><span class="line">&quot;abcdef&quot;</span><br><span class="line">127.0.0.1:6379&gt; setrange key2 2 xxx</span><br><span class="line">(integer) 6</span><br><span class="line">127.0.0.1:6379&gt; get key2</span><br><span class="line">&quot;abxxxf&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">##########################################################################################3</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> setex</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> setnx</span></span><br><span class="line">127.0.0.1:6379&gt; setex key3 30 &quot;hello&quot;</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; ttl key3</span><br><span class="line">(integer) 25</span><br><span class="line">127.0.0.1:6379&gt; get key3</span><br><span class="line">&quot;hello&quot;</span><br><span class="line">127.0.0.1:6379&gt; setnx mykey &quot;redis&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;key2&quot;</span><br><span class="line">2) &quot;mykey&quot;</span><br><span class="line">3) &quot;key1&quot;</span><br><span class="line">4) &quot;views&quot;</span><br><span class="line">5) &quot;views2&quot;</span><br><span class="line">127.0.0.1:6379&gt; ttl key3</span><br><span class="line">(integer) -2</span><br><span class="line">127.0.0.1:6379&gt; get mykey</span><br><span class="line">&quot;redis&quot;</span><br><span class="line">127.0.0.1:6379&gt; setnx mykey &quot;mongodb&quot;</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; get mykey</span><br><span class="line">&quot;redis&quot;</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###########################################################################################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mset</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mget</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> msetnx 原子操作 只有所有的键都不存在时，同时创建的键才会创建成功</span></span><br><span class="line">127.0.0.1:6379&gt; mset k1 v1 k2 v2 k3 v3</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; mget k1 k2</span><br><span class="line">1) &quot;v1&quot;</span><br><span class="line">2) &quot;v2&quot;</span><br><span class="line">127.0.0.1:6379&gt; msetnx k1 v1 k4 v4</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; get k4</span><br><span class="line">(nil)</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###########################################################################################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> 对象</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> mset user:1:键1 值1 user:1:键2 值2 [user:1:键3 值3 ...]</span></span><br><span class="line">127.0.0.1:6379&gt; mset user:1:name zhangsan user:1:age 18</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; mget user:1:name user:1:age</span><br><span class="line">1) &quot;zhangsan&quot;</span><br><span class="line">2) &quot;18&quot;</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment">###############################################################################################</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> getset 先 get 后 <span class="built_in">set</span></span></span><br><span class="line">127.0.0.1:6379&gt; getset db redis</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; get db</span><br><span class="line">&quot;redis&quot;</span><br><span class="line">127.0.0.1:6379&gt; getset db mongodb</span><br><span class="line">&quot;redis&quot;</span><br><span class="line">127.0.0.1:6379&gt; get db</span><br><span class="line">&quot;mongodb&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>String 使用场景：</p>
<ul>
<li>计数器</li>
<li>统计多单位的数量</li>
<li>粉丝数</li>
<li>对象缓存存储</li>
</ul>
<h3 id="3-3-List（列表）"><a href="#3-3-List（列表）" class="headerlink" title="3.3 List（列表）"></a>3.3 List（列表）</h3><p><img src="https://i.loli.net/2021/04/21/gVjmZJQOhSuPaL8.png" alt="image.png"></p>
<p>说明：所有的 list 命令都是以 l 开头，Redis 中的命令不区分大小写</p>
<ul>
<li><code>lpush</code>：从左面向列表中插入元素</li>
<li><code>rpush</code>：从右面向列表中插入元素</li>
<li><code>lrange</code>：获取指定范围的额元素，如果获取所有元素采用下标[0 -1]</li>
<li><code>lpop</code>：从列表的左端弹出元素</li>
<li><code>rpop</code>：从列表的右端弹出元素</li>
<li><code>lindex</code>：获取指定下标的元素</li>
<li><code>llen</code>：获取列表的长度</li>
<li><code>lrem</code>：移除指定元素，移除时需要标明移除几个</li>
<li><code>ltrim</code>：截取指定范围的元素</li>
<li><code>rpoplpush</code>：从一个列表的右端弹出一个元素，并将该元素插入到新的列表的左端</li>
<li><code>lset</code>：将列表中指定下标的值设置为新的值</li>
<li><code>linsert</code>：在列表中某个元素前或者某个元素后插入某个元素</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># lpush</span></span><br><span class="line"><span class="comment"># lrange</span></span><br><span class="line"><span class="comment"># rpush</span></span><br><span class="line">127.0.0.1:6379&gt; lpush mylist hello</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; lpush mylist hello1</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; lpush mylist hello2</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lrange mylist 0 -1</span><br><span class="line">1) <span class="string">&quot;hello2&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">3) <span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; rpush mylist hello3</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; lrange mylist 0 -1</span><br><span class="line">1) <span class="string">&quot;hello2&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">3) <span class="string">&quot;hello&quot;</span></span><br><span class="line">4) <span class="string">&quot;hello3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># lpop</span></span><br><span class="line"><span class="comment"># rpop</span></span><br><span class="line">127.0.0.1:6379&gt; lpop mylist 0</span><br><span class="line">(nil)</span><br><span class="line">127.0.0.1:6379&gt; lpop mylist 1</span><br><span class="line">1) <span class="string">&quot;hello2&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange mylist 0 -1</span><br><span class="line">1) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello&quot;</span></span><br><span class="line">3) <span class="string">&quot;hello3&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; rpop mylist 1</span><br><span class="line">1) <span class="string">&quot;hello3&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange mylist 0 -1</span><br><span class="line">1) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># lindex</span></span><br><span class="line"><span class="comment"># llen</span></span><br><span class="line"><span class="comment"># lrem</span></span><br><span class="line">127.0.0.1:6379&gt; lindex mylist 1</span><br><span class="line"><span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lindex mylist 0</span><br><span class="line"><span class="string">&quot;hello1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; llen mylist</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; lpush mylist hello</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lrange mylist 0 -1</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">3) <span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrem mylist 2 hello</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line"></span><br><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># ltrim</span></span><br><span class="line">127.0.0.1:6379&gt; lrange mylist 0 -1</span><br><span class="line">1) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lpush mylist hello2</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; lpush mylist hello3</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lpush mylist hello4</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; ltrim mylist 1 2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lrange mylist 0 -1</span><br><span class="line">1) <span class="string">&quot;hello3&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># rpoplpush</span></span><br><span class="line">127.0.0.1:6379&gt; rpoplpush mylist otherlist</span><br><span class="line"><span class="string">&quot;hello2&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange mylist 0 -1</span><br><span class="line">1) <span class="string">&quot;hello3&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; lrange mylist otherlist</span><br><span class="line">(error) ERR wrong number of arguments <span class="keyword">for</span> <span class="string">&#x27;lrange&#x27;</span> <span class="built_in">command</span></span><br><span class="line">127.0.0.1:6379&gt; lrange otherlist 0 -1</span><br><span class="line">1) <span class="string">&quot;hello2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># lset</span></span><br><span class="line"><span class="comment"># linsert</span></span><br><span class="line">127.0.0.1:6379&gt; lset mylist 0 hello</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; lrange mylist 0 -1</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; linsert mylist before hello hello1</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; lrange mylist 0 -1</span><br><span class="line">1) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; linsert mylist after hello hello0</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; lrange mylist 0 -1</span><br><span class="line">1) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello&quot;</span></span><br><span class="line">3) <span class="string">&quot;hello0&quot;</span></span><br></pre></td></tr></table></figure>

<p><strong>小结：</strong></p>
<ul>
<li>list 实际上是一个链表，从左端、右端、中间都可以插入元素</li>
<li>如果 key 不存在，也就是链表不存在，创建新的链表</li>
<li>如果 key 存在，新增内容</li>
<li>如果移除了所有元素，空链表，也代表链表不存在</li>
<li>在两边插入或弹出元素的效率最高，在中间处理元素效率相对来说底一些</li>
</ul>
<p>作用：消息队列、普通队列、栈。</p>
<h3 id="3-4-Set（集合）"><a href="#3-4-Set（集合）" class="headerlink" title="3.4 Set（集合）"></a>3.4 Set（集合）</h3><p>集合中没有重复的元素，元素之间无需，集合相关的命令是以 s 开头</p>
<ul>
<li><code>sadd</code>：向集合中增加元素</li>
<li><code>smembers</code>：查看集合中所有的元素</li>
<li><code>sismenber</code>：判断当前的元素是否在集合中</li>
<li><code>scard</code>：统计集合中元素的个数</li>
<li><code>srem</code>：移除集合中指定的元素</li>
<li><code>srandmember</code>：随机抽取集合中的元素</li>
<li><code>spop</code>：随机删除集合中的元素</li>
<li><code>smove</code>：将一个集合中的指定元素移动到另外一个集合中</li>
<li><code>sdiff</code>：两个集合的差集</li>
<li><code>sinter</code>：两个集合的交集</li>
<li><code>sunion</code>：两个集合的并集</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># sadd</span></span><br><span class="line"><span class="comment"># smembers</span></span><br><span class="line"><span class="comment"># sismember</span></span><br><span class="line">127.0.0.1:6379&gt; sadd myset hello</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd myset hello1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd myset hello2</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; smembers myset</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello2&quot;</span></span><br><span class="line">3) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; sismember myset hello3</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; sismember myset hello2</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># scard</span></span><br><span class="line">127.0.0.1:6379&gt; scard myset</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; smembers myset</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello2&quot;</span></span><br><span class="line">3) <span class="string">&quot;hello1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># srandmember</span></span><br><span class="line">127.0.0.1:6379&gt; srandmember myset</span><br><span class="line"><span class="string">&quot;hello1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; srandmember myset</span><br><span class="line"><span class="string">&quot;hello1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; srandmember myset</span><br><span class="line"><span class="string">&quot;hello2&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; srandmember myset</span><br><span class="line"><span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; srandmember myset</span><br><span class="line"><span class="string">&quot;hello1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; srandmember myset 2</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; srandmember myset 2</span><br><span class="line">1) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello2&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; srandmember myset 2</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># spop</span></span><br><span class="line">127.0.0.1:6379&gt; spop myset</span><br><span class="line"><span class="string">&quot;hello2&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; spop myset</span><br><span class="line"><span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; smembers myset</span><br><span class="line">1) <span class="string">&quot;hello1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># smove</span></span><br><span class="line">127.0.0.1:6379&gt; sadd otherser other</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; smove myset otherser hello</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; smembers myset</span><br><span class="line">1) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; smove myset otherser hello1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; smembers myset</span><br><span class="line">(empty array)</span><br><span class="line">127.0.0.1:6379&gt; smembers otherser</span><br><span class="line">1) <span class="string">&quot;other&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># sdiff</span></span><br><span class="line"><span class="comment"># sinter</span></span><br><span class="line"><span class="comment"># sunion</span></span><br><span class="line">127.0.0.1:6379&gt; sadd key1 a</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd key1 a b c</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; sadd key2 c d e</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; sdiff key1 key2</span><br><span class="line">1) <span class="string">&quot;b&quot;</span></span><br><span class="line">2) <span class="string">&quot;a&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; sinter key1 key2</span><br><span class="line">1) <span class="string">&quot;c&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; sunion key1 key2</span><br><span class="line">1) <span class="string">&quot;a&quot;</span></span><br><span class="line">2) <span class="string">&quot;c&quot;</span></span><br><span class="line">3) <span class="string">&quot;b&quot;</span></span><br><span class="line">4) <span class="string">&quot;d&quot;</span></span><br><span class="line">5) <span class="string">&quot;e&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><strong>作用：</strong> 共同关注、共同爱好、二度好友、推荐好友</p>
<h3 id="3-5-Hash（哈希）"><a href="#3-5-Hash（哈希）" class="headerlink" title="3.5 Hash（哈希）"></a>3.5 Hash（哈希）</h3><p>Hash 相当于一个 Map 集合（key-map），本质上和 string 类型没有太大区别，还是一个简单的 key-value。</p>
<p>Hash 相关的命令都是以 h 开头：</p>
<ul>
<li><code>hset</code>：向哈希中增加键值对，可同时增加多个</li>
<li><code>hget</code>：获取哈希中键的值</li>
<li><code>hmset</code>：同时向哈希中增加多个键值对</li>
<li><code>hmget</code>：同时获取哈希中多个键值对</li>
<li><code>hdel</code>：删除哈希中的某个键</li>
<li><code>hgetall</code>：获取哈希中所有的键值对（结果会以键值交替的形式显示）</li>
<li><code>hlen</code>：获得哈希的长度</li>
<li><code>hexists</code>：查看哈希中某个键是否存在</li>
<li><code>hkeys</code>：获取哈希中所有的键</li>
<li><code>hvals</code>：获取哈希中所有的值</li>
<li><code>hincrby</code>：将哈希中的某个键对应的值增加几（若这个增量是负的，则是减少几）</li>
<li><code>hsetnx</code>：如果哈希中某个键不存在，则增加该键值对；否则该键值对不予处理</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># hset</span></span><br><span class="line"><span class="comment"># hget</span></span><br><span class="line"><span class="comment"># hmset</span></span><br><span class="line"><span class="comment"># hmget</span></span><br><span class="line"><span class="comment"># hgetall</span></span><br><span class="line">127.0.0.1:6379&gt; hset myset key1 hello key2 world</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; hget myset key1 </span><br><span class="line"><span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; hmset myset key3 hello1 keys4 world1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; hmget myset key1 key2 key3 key4</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;world&quot;</span></span><br><span class="line">3) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">4) (nil)</span><br><span class="line">127.0.0.1:6379&gt; hmget myset key1 key2 key3 keys4</span><br><span class="line">1) <span class="string">&quot;hello&quot;</span></span><br><span class="line">2) <span class="string">&quot;world&quot;</span></span><br><span class="line">3) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">4) <span class="string">&quot;world1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; hgetall myset</span><br><span class="line">1) <span class="string">&quot;key1&quot;</span></span><br><span class="line">2) <span class="string">&quot;hello&quot;</span></span><br><span class="line">3) <span class="string">&quot;key2&quot;</span></span><br><span class="line">4) <span class="string">&quot;world&quot;</span></span><br><span class="line">5) <span class="string">&quot;key3&quot;</span></span><br><span class="line">6) <span class="string">&quot;hello1&quot;</span></span><br><span class="line">7) <span class="string">&quot;keys4&quot;</span></span><br><span class="line">8) <span class="string">&quot;world1&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># hlen</span></span><br><span class="line"><span class="comment"># hexists</span></span><br><span class="line">127.0.0.1:6379&gt; hlen myset</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; hexists myset key5</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; hexists myset key1</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hexists myhash key</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line"></span><br><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># hkeys</span></span><br><span class="line"><span class="comment"># hvals</span></span><br><span class="line">127.0.0.1:6379&gt; hset myhash key1 v1 key2 v2 key3 v3 key4 v4</span><br><span class="line">(<span class="built_in">integer</span>) 4</span><br><span class="line">127.0.0.1:6379&gt; hkeys myhash</span><br><span class="line">1) <span class="string">&quot;key1&quot;</span></span><br><span class="line">2) <span class="string">&quot;key2&quot;</span></span><br><span class="line">3) <span class="string">&quot;key3&quot;</span></span><br><span class="line">4) <span class="string">&quot;key4&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; hvals myhash</span><br><span class="line">1) <span class="string">&quot;v1&quot;</span></span><br><span class="line">2) <span class="string">&quot;v2&quot;</span></span><br><span class="line">3) <span class="string">&quot;v3&quot;</span></span><br><span class="line">4) <span class="string">&quot;v4&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># hincrby</span></span><br><span class="line"><span class="comment"># hsetnx</span></span><br><span class="line"><span class="comment"># hdel</span></span><br><span class="line">127.0.0.1:6379&gt; hincrby myhash k5 -5</span><br><span class="line">(<span class="built_in">integer</span>) 11</span><br><span class="line">127.0.0.1:6379&gt; hsetnx myhash key5 v5</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; hsetnx myhash key5 v6</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; hdel myhash key5</span><br><span class="line">(<span class="built_in">integer</span>) 1 </span><br></pre></td></tr></table></figure>

<p><strong>作用：</strong> 常用于存储经常变动的信息，例如：用户的 name、age、等等，hash 更适合于对象的存储，string 更适合字符串的存储</p>
<h3 id="3-6-Zset（有序集合）"><a href="#3-6-Zset（有序集合）" class="headerlink" title="3.6 Zset（有序集合）"></a>3.6 Zset（有序集合）</h3><p>相对于 Set 而言，Zset 是一个有序的集合，也就是说在 Zset 中存储的元素是有序的。增加元素时：<code>set k1 v1</code>，<code>zset k1 score v1</code></p>
<ul>
<li><code>zadd</code>：向有序集合中添加元素</li>
<li><code>zrange</code>：获取集合中指定范围（下标）的元素</li>
<li><code>zcount</code>：获取集合中元素值所定范围的元素的个数</li>
<li><code>zcard</code>：获取集合中元素的数量</li>
<li><code>zrem</code>：删除指定的元素</li>
<li><code>zrangebyscore</code>：获取有序集合中指定值范围（元素的值）的元素</li>
<li><code>zrevrange</code>：获取指定范围的元素，从高到低排列</li>
<li><code>zrevrangebyscore</code>：获取有续集和中指定值范围的元素，从高到低排列</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># zadd</span></span><br><span class="line"><span class="comment"># zrange</span></span><br><span class="line">127.0.0.1:6379&gt; zadd myzset 2500 xiaofang</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zadd myzset 3000 liugang 3500 zhanghua</span><br><span class="line">(<span class="built_in">integer</span>) 2</span><br><span class="line">127.0.0.1:6379&gt; zrange myzset 0 -1</span><br><span class="line">1) <span class="string">&quot;xiaofang&quot;</span></span><br><span class="line">2) <span class="string">&quot;liugang&quot;</span></span><br><span class="line">3) <span class="string">&quot;zhanghua&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zadd myzset 1000 lihua</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zrange myzset 0 -1</span><br><span class="line">1) <span class="string">&quot;lihua&quot;</span></span><br><span class="line">2) <span class="string">&quot;xiaofang&quot;</span></span><br><span class="line">3) <span class="string">&quot;liugang&quot;</span></span><br><span class="line">4) <span class="string">&quot;zhanghua&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># zrangebyscore</span></span><br><span class="line"><span class="comment"># zrevrange</span></span><br><span class="line">127.0.0.1:6379&gt; zrangebyscore myzset -inf +inf</span><br><span class="line">1) <span class="string">&quot;lihua&quot;</span></span><br><span class="line">2) <span class="string">&quot;xiaofang&quot;</span></span><br><span class="line">3) <span class="string">&quot;liugang&quot;</span></span><br><span class="line">4) <span class="string">&quot;zhanghua&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zrevrange myzset 0 -1</span><br><span class="line">1) <span class="string">&quot;zhanghua&quot;</span></span><br><span class="line">2) <span class="string">&quot;liugang&quot;</span></span><br><span class="line">3) <span class="string">&quot;xiaofang&quot;</span></span><br><span class="line">4) <span class="string">&quot;lihua&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zrangebyscore myzset -inf 2000</span><br><span class="line">1) <span class="string">&quot;lihua&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zrangebyscore myzset -inf 3000</span><br><span class="line">1) <span class="string">&quot;lihua&quot;</span></span><br><span class="line">2) <span class="string">&quot;xiaofang&quot;</span></span><br><span class="line">3) <span class="string">&quot;liugang&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">###################################################################################################</span></span><br><span class="line"><span class="comment"># zrem</span></span><br><span class="line"><span class="comment"># zcard</span></span><br><span class="line"><span class="comment"># zcount</span></span><br><span class="line">127.0.0.1:6379&gt; zrem myzset lihua</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; zrange myzset 0 -1</span><br><span class="line">1) <span class="string">&quot;xiaofang&quot;</span></span><br><span class="line">2) <span class="string">&quot;liugang&quot;</span></span><br><span class="line">3) <span class="string">&quot;zhanghua&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; zcard myzset</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; zcount myzset 1000 2500</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure>

<p>可以通过查看官方文档学习一些相关的 API</p>
<p><strong>作用：</strong></p>
<ul>
<li>班级成绩表、工资表</li>
<li>普通消息 1，重要消息 2，带权重进行判断</li>
<li>排行榜，取 Top N</li>
</ul>
<h2 id="4-三种特殊的数据类型"><a href="#4-三种特殊的数据类型" class="headerlink" title="4 三种特殊的数据类型"></a>4 三种特殊的数据类型</h2><h3 id="4-1-Geospatial-（地理位置）"><a href="#4-1-Geospatial-（地理位置）" class="headerlink" title="4.1 Geospatial （地理位置）"></a>4.1 Geospatial （地理位置）</h3><p>可以通过网站查看城市的经纬度信息。</p>
<p>Geo 相关的命令有 8 个：这里只列出 6 个</p>
<ul>
<li><code>geoadd</code>：将指定的地理空间位置（经度、纬度、名称）添加到指定的 key 中</li>
<li><code>geodist</code>：返回两个给定位置之间的距离</li>
<li><code>geohash</code>：返回一个或多个位置元素的 geohash 表示</li>
<li><code>geopos</code>：从 key 里返回所有给定位置元素的位置（经度、纬度）</li>
<li><code>georadius</code>：以给定的经纬度为中心，找出某一半径内的元素</li>
<li><code>georadiusbymember</code>：找出位于指定范围内的元素，中心点是由给定的位置元素指定</li>
</ul>
<blockquote>
<p>geoadd</p>
</blockquote>
<p>说明：有效的经度从-180度到180度；有效的纬度从-85.05112878度到85.05112878度。坐标超出指定范围会报错。一般情况下，会下载城市数据，通过程序一次性导入。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geoadd china:city 116.4 40.4 beijing</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 121.4 31.3 shanghai 120.2 30.3 hangzhou 118.1 24.5 xiamen</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br><span class="line">127.0.0.1:6379&gt; geoadd china:city 108.9 34.3 xi_an</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>geopos</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geopos china:city beijing</span><br><span class="line">1) 1) <span class="string">&quot;116.39999896287918091&quot;</span></span><br><span class="line">   2) <span class="string">&quot;40.39999918756212338&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; geopos china:city beijing shanghai hangzhou</span><br><span class="line">1) 1) <span class="string">&quot;116.39999896287918091&quot;</span></span><br><span class="line">   2) <span class="string">&quot;40.39999918756212338&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;121.40000134706497192&quot;</span></span><br><span class="line">   2) <span class="string">&quot;31.30000043401529553&quot;</span></span><br><span class="line">3) 1) <span class="string">&quot;120.20000249147415161&quot;</span></span><br><span class="line">   2) <span class="string">&quot;30.29999970751173777&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>geodist<br>说明：</p>
</blockquote>
<ul>
<li>m 表示单位为米。</li>
<li>km 表示单位为千米。</li>
<li>mi 表示单位为英里。</li>
<li>ft 表示单位为英尺。<br>如果用户没有显式地指定单位参数， 那么 GEODIST 默认使用米作为单位。</li>
</ul>
<p>返回值：计算出的距离会以双精度浮点数的形式被返回。 如果给定的位置元素不存在， 那么命令返回空值。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geodist china:city beijing shanghai</span><br><span class="line"><span class="string">&quot;1107484.3678&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; geodist china:city beijing shanghai km</span><br><span class="line"><span class="string">&quot;1107.4844&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; geodist china:city xi_an beijing km</span><br><span class="line"><span class="string">&quot;948.0069&quot;</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>georadius<br>范围可以使用以下其中一个单位：</p>
</blockquote>
<ul>
<li>m 表示单位为米。</li>
<li>km 表示单位为千米。</li>
<li>mi 表示单位为英里。</li>
<li>ft 表示单位为英尺。<br>在给定以下可选项时， 命令会返回额外的信息：</li>
<li>WITHDIST: 在返回位置元素的同时， 将位置元素与中心之间的距离也一并返回。 距离的单位和用户给定的范围单位保持一致。</li>
<li>WITHCOORD: 将位置元素的经度和维度也一并返回。</li>
<li>WITHHASH: 以 52 位有符号整数的形式， 返回位置元素经过原始 geohash 编码的有序集合分值。 这个选项主要用于底层应用或者调试， 实际中的作用并不大。</li>
</ul>
<p>命令默认返回未排序的位置元素。 通过以下两个参数， 用户可以指定被返回位置元素的排序方式：</p>
<ul>
<li>ASC: 根据中心的位置， 按照从近到远的方式返回位置元素。</li>
<li>DESC: 根据中心的位置， 按照从远到近的方式返回位置元素。<br>在默认情况下， GEORADIUS 命令会返回所有匹配的位置元素。 虽然用户可以使用 COUNT <count> 选项去获取前 N 个匹配元素， 但是因为命令在内部可能会需要对所有被匹配的元素进行处理， 所以在对一个非常大的区域进行搜索时， 即使只使用 COUNT 选项去获取少量元素， 命令的执行速度也可能会非常慢。 但是从另一方面来说， 使用 COUNT 选项去减少需要返回的元素数量， 对于减少带宽来说仍然是非常有用的。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 1000 km</span><br><span class="line">1) <span class="string">&quot;xi_an&quot;</span></span><br><span class="line">2) <span class="string">&quot;hangzhou&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 1000 km withcoord</span><br><span class="line">1) 1) <span class="string">&quot;xi_an&quot;</span></span><br><span class="line">   2) 1) <span class="string">&quot;108.90000075101852417&quot;</span></span><br><span class="line">      2) <span class="string">&quot;34.30000007880482116&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;hangzhou&quot;</span></span><br><span class="line">   2) 1) <span class="string">&quot;120.20000249147415161&quot;</span></span><br><span class="line">      2) <span class="string">&quot;30.29999970751173777&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 1000 km withdist</span><br><span class="line">1) 1) <span class="string">&quot;xi_an&quot;</span></span><br><span class="line">   2) <span class="string">&quot;489.3510&quot;</span></span><br><span class="line">2) 1) <span class="string">&quot;hangzhou&quot;</span></span><br><span class="line">   2) <span class="string">&quot;981.2625&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 1000 km withhash</span><br><span class="line">1) 1) <span class="string">&quot;xi_an&quot;</span></span><br><span class="line">   2) (<span class="built_in">integer</span>) 4040115568361978</span><br><span class="line">2) 1) <span class="string">&quot;hangzhou&quot;</span></span><br><span class="line">   2) (<span class="built_in">integer</span>) 4054134458003393</span><br><span class="line">127.0.0.1:6379&gt; georadius china:city 110 30 1000 km withdist withcoord count 1</span><br><span class="line">1) 1) <span class="string">&quot;xi_an&quot;</span></span><br><span class="line">   2) <span class="string">&quot;489.3510&quot;</span></span><br><span class="line">   3) 1) <span class="string">&quot;108.90000075101852417&quot;</span></span><br><span class="line">      2) <span class="string">&quot;34.30000007880482116&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>


<blockquote>
<p>georadiusbymember</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; georadiusbymember china:city beijing 1000 km</span><br><span class="line">1) <span class="string">&quot;beijing&quot;</span></span><br><span class="line">2) <span class="string">&quot;xi_an&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>geohash</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; geohash china:city beijing xi_an</span><br><span class="line">1) <span class="string">&quot;wx4vbdxgh90&quot;</span></span><br><span class="line">2) <span class="string">&quot;wqj7nh4ecz0&quot;</span></span><br></pre></td></tr></table></figure>

<p>geo 的底层原理：就是一个 Zset，所以可以使用操作 Zset 的命令，来操作 geo</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zrange china:city 0 -1</span><br><span class="line">1) <span class="string">&quot;xi_an&quot;</span></span><br><span class="line">2) <span class="string">&quot;xiamen&quot;</span></span><br><span class="line">3) <span class="string">&quot;hangzhou&quot;</span></span><br><span class="line">4) <span class="string">&quot;shanghai&quot;</span></span><br><span class="line">5) <span class="string">&quot;beijing&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="4-2-Hyperloglog"><a href="#4-2-Hyperloglog" class="headerlink" title="4.2 Hyperloglog"></a>4.2 Hyperloglog</h3><blockquote>
<p>什么是基数？</p>
</blockquote>
<p>A = {1，2，3，4，5}<br>B = {1，1，2，3，4，5}<br>基数（不重复的元素）= 5</p>
<blockquote>
<p>Hyperloglog 是基数统计算法</p>
</blockquote>
<p>优点：占用的内存是固定的，2^64 不同的元素，只需要 12KB 内存，如果从内存的角度考虑 Hyperloglog 是首选。</p>
<ul>
<li><code>PFadd</code>：增加元素</li>
<li><code>PFcount</code>：统计元素的数量</li>
<li><code>PFmerge</code>：合并元素<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; PFadd mykey a b c d e f</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; PFcount mykey</span><br><span class="line">(<span class="built_in">integer</span>) 6</span><br><span class="line">127.0.0.1:6379&gt; PFadd mykey1 e f g h i l m n</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; PFcount mykey1</span><br><span class="line">(<span class="built_in">integer</span>) 8</span><br><span class="line">127.0.0.1:6379&gt; PFmerge mykey2 mykey mykey1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; PFcount mykey2</span><br><span class="line">(<span class="built_in">integer</span>) 12</span><br></pre></td></tr></table></figure>

</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; PFadd mykey a b c d e f</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; PFcount mykey</span><br><span class="line">(<span class="built_in">integer</span>) 6</span><br><span class="line">127.0.0.1:6379&gt; PFadd mykey1 e f g h i l m n</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; PFcount mykey1</span><br><span class="line">(<span class="built_in">integer</span>) 8</span><br><span class="line">127.0.0.1:6379&gt; PFmerge mykey2 mykey mykey1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; PFcount mykey2</span><br><span class="line">(<span class="built_in">integer</span>) 12</span><br></pre></td></tr></table></figure>

<p><strong>作用：</strong></p>
<ul>
<li><strong>网页的 UV（一个人访问网站多次，但是还是算作一个人）</strong> ，传统的方式用 set 保存用户的 id，然后就可以统计 set 中元素数量作为标准，这个方式如果保存大量的用户就比较麻烦，因为我们的目的是计数，而不是保存用户的 id。</li>
</ul>
<p><strong>说明：</strong><br>如果允许容错，那么就一定使用 Hyperloglog；否则使用 set。</p>
<h3 id="4-3-bitmap（位图）"><a href="#4-3-bitmap（位图）" class="headerlink" title="4.3 bitmap（位图）"></a>4.3 bitmap（位图）</h3><p>使用 bitmap 来统计一周的打卡天数：</p>
<ul>
<li><code>setbit</code>：增加标记位</li>
<li><code>getbit</code>：获取标记位</li>
<li><code>bitcount</code>：统计标记位<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; setbit sign 0 1</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 1 0</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 2 0</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 3 1</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 4 0</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 5 1</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; setbit sign 6 0</span><br><span class="line">(<span class="built_in">integer</span>) 0</span><br><span class="line">127.0.0.1:6379&gt; getbit sign 5</span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; bitcount sign</span><br><span class="line">(<span class="built_in">integer</span>) 3</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>作用：</strong> 一般只要涉及两个状态的都可以使用 bitmap</p>
<ul>
<li>统计用户信息：活跃、不活跃</li>
<li>统计是否登录</li>
<li>统计打卡天数</li>
</ul>
<h2 id="5-事务"><a href="#5-事务" class="headerlink" title="5 事务"></a>5 事务</h2><p>Redis 事务的本质：一组命令的集合。一个事务中所有的命令都会被序列化，在事务执行的过程中，会按照顺序执行。<br>Redis 事务的特性：一次性、顺序性、排他性。</p>
<blockquote>
<p>———-队列 set set set 执行————–</p>
</blockquote>
<ul>
<li><strong>Redis 事务没有隔离级别的概念。</strong></li>
<li>所有的命令在事务中，并没有直接被执行，只有发起执行命令（exec）的时候才会执行。</li>
<li><strong>Redis 单条命令是保存原子性的，但是事务不保证原子性。</strong></li>
</ul>
<p>Redis 事务的流程：</p>
<ul>
<li>开启事务（multi）</li>
<li>命令入队（…..）</li>
<li>执行事务（exec）</li>
</ul>
<blockquote>
<p>正常执行的事务</p>
</blockquote>
<ul>
<li><code>multi</code>：开启事务</li>
<li><code>exec</code>：执行事务<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi <span class="comment"># 开启事务</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> myset hello</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> myset hello1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> myset hello2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> myset hello3</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> myset1 hello</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">exec</span> <span class="comment"># 执行事务</span></span><br><span class="line">1) OK</span><br><span class="line">2) OK</span><br><span class="line">3) OK</span><br><span class="line">4) OK</span><br><span class="line">5) OK</span><br></pre></td></tr></table></figure>
<blockquote>
<p>放弃事务</p>
</blockquote>
</li>
<li><code>discard</code>：放弃事务<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> myset1 hello</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> myset1 hello1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> myset1 hello2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; discard</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get myset1</span><br><span class="line"><span class="string">&quot;hello&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
</ul>
<blockquote>
<p>编译型异常（代码有问题，命令有错），事务中的所有命令都不会被执行。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> myset2 hello</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> myset2 hello1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> myset2 hello2</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; getset myset2</span><br><span class="line">(error) ERR wrong number of arguments <span class="keyword">for</span> <span class="string">&#x27;getset&#x27;</span> <span class="built_in">command</span></span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> myset2 hello3</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">exec</span></span><br><span class="line">(error) EXECABORT Transaction discarded because of previous errors.</span><br></pre></td></tr></table></figure>

<blockquote>
<p>运行时异常，如果事务队列中的命令不存在语法性的问题，那么执行命令的时候，其他命令是可以正常执行的，错误的命令抛出异常。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k1 v1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; incr k1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> myset3 hello</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">set</span> myset4 hello1</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">exec</span></span><br><span class="line">1) (error) ERR value is not an <span class="built_in">integer</span> or out of range</span><br><span class="line">2) OK</span><br><span class="line">3) OK</span><br><span class="line">127.0.0.1:6379&gt; get myset3</span><br><span class="line"><span class="string">&quot;hello&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; get myset4</span><br><span class="line"><span class="string">&quot;hello1&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>监控：watch （面试常问）</p>
</blockquote>
<p><strong>悲观锁：</strong></p>
<ul>
<li>很悲观！认为什么时候都会出现问题，任何情况下都会加锁。</li>
</ul>
<p><strong>乐观锁：</strong></p>
<ul>
<li>很乐观！认为什么时候都不会出现问题，所以不会上锁。（更新数据的时候会去判断一下，在此期间是否有人修改过该数据。）</li>
<li>实现方法：采用 watch 监测数据，更新数据的时候判断下数据是否改变。</li>
</ul>
<blockquote>
<p>Redis 监视测试</p>
</blockquote>
<p>正常执行：</p>
<ul>
<li><code>watch</code>：监视对象<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> money 100</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> out 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; watch money  <span class="comment"># 监视 money 对象</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi <span class="comment"># 执行事务</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; decrby money 20 </span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; incrby out 20</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">exec</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 80</span><br><span class="line">2) (<span class="built_in">integer</span>) 20</span><br></pre></td></tr></table></figure>
测试多线程更新数据（开启另一个窗口模拟多线程）：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在1号窗口执行如下命令</span></span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; decrby money 15</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; incrby out 15</span><br><span class="line">QUEUED</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此时，在2号窗口中更新 money</span></span><br><span class="line">127.0.0.1:6379&gt; incrby money 1000</span><br><span class="line">(<span class="built_in">integer</span>) 1080</span><br><span class="line"></span><br><span class="line"><span class="comment"># 回到1号窗口执行事务，发现执行失败</span></span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">exec</span></span><br><span class="line">(nil)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
</ul>
<p>在更新数据失败的时候获取新的值就可以：</p>
<ul>
<li><code>unwatch</code>：如果发现事务执行失败就先解锁</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; unwatch</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; watch money</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; decrby money 15</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; incrby out 15</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; <span class="built_in">exec</span></span><br><span class="line">1) (<span class="built_in">integer</span>) 1065</span><br><span class="line">2) (<span class="built_in">integer</span>) 35</span><br></pre></td></tr></table></figure>

<h2 id="6-Redis-conf-配置文件"><a href="#6-Redis-conf-配置文件" class="headerlink" title="6 Redis.conf 配置文件"></a>6 Redis.conf 配置文件</h2><p>启动的时候，通过配置文件来启动。</p>
<blockquote>
<p>单位</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1k =&gt; 1000 bytes</span></span><br><span class="line"><span class="comment"># 1kb =&gt; 1024 bytes</span></span><br><span class="line"><span class="comment"># 1m =&gt; 1000000 bytes</span></span><br><span class="line"><span class="comment"># 1mb =&gt; 1024*1024 bytes</span></span><br><span class="line"><span class="comment"># 1g =&gt; 1000000000 bytes</span></span><br><span class="line"><span class="comment"># 1gb =&gt; 1024*1024*1024 bytes</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>包含 INCLUDES</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">################################## INCLUDES ###################################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Include one or more other config files here.  This is useful if you</span></span><br><span class="line"><span class="comment"># have a standard template that goes to all Redis servers but also need</span></span><br><span class="line"><span class="comment"># to customize a few per-server settings.  Include files can include</span></span><br><span class="line"><span class="comment"># other files, so use this wisely.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Note that option &quot;include&quot; won&#x27;t be rewritten by command &quot;CONFIG REWRITE&quot;</span></span><br><span class="line"><span class="comment"># from admin or Redis Sentinel. Since Redis always uses the last processed</span></span><br><span class="line"><span class="comment"># line as value of a configuration directive, you&#x27;d better put includes</span></span><br><span class="line"><span class="comment"># at the beginning of this file to avoid overwriting config change at runtime.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If instead you are interested in using includes to override configuration</span></span><br><span class="line"><span class="comment"># options, it is better to use include as the last line.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># include /path/to/local.conf</span></span><br><span class="line"><span class="comment"># include /path/to/other.conf</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>网络 NETWORK</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">bind</span> 127.0.0.1 -::1 <span class="comment"># 绑定 ip，意味着 redis 仅能接受来自该 ip 的请求，如果不进行设置，会处理所有的请求</span></span><br><span class="line">protected-mode yes <span class="comment"># 默认开启保护模式，如果没有 bind ip 地址，或者没有设置密码，最好将保护模式开启；开启后意味着 redis 只会进行本地访问</span></span><br><span class="line">port 6379 <span class="comment"># redis 监听的端口号</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>通用配置 GENERAL</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">daemonize yes <span class="comment"># 以守护进程的方式运行，默认是 no，需要开启时为 yes</span></span><br><span class="line">pidfile /var/run/redis_6379.pid <span class="comment"># redis 的进程文件。以后台的方式运行，就需要指定一个 pid 文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志</span></span><br><span class="line"><span class="comment"># Specify the server verbosity level.</span></span><br><span class="line"><span class="comment"># This can be one of:</span></span><br><span class="line"><span class="comment"># debug (a lot of information, useful for development/testing)</span></span><br><span class="line"><span class="comment"># verbose (many rarely useful info, but not a mess like the debug level)</span></span><br><span class="line"><span class="comment"># notice (moderately verbose, what you want in production probably)</span></span><br><span class="line"><span class="comment"># warning (only very important / critical messages are logged)</span></span><br><span class="line">loglevel notice <span class="comment"># 指定日志级别</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Specify the log file name. Also the empty string can be used to force</span></span><br><span class="line"><span class="comment"># Redis to log on the standard output. Note that if you use standard</span></span><br><span class="line"><span class="comment"># output for logging but daemonize, logs will be sent to /dev/null</span></span><br><span class="line">logfile <span class="string">&quot;&quot;</span> <span class="comment"># 指定记录日志的文件。空字符串表示日志会打印到输出设备上</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set the number of databases. The default database is DB 0, you can select</span></span><br><span class="line"><span class="comment"># a different one on a per-connection basis using SELECT &lt;dbid&gt; where</span></span><br><span class="line"><span class="comment"># dbid is a number between 0 and &#x27;databases&#x27;-1</span></span><br><span class="line">databases 16 <span class="comment"># 数据库的数量</span></span><br><span class="line"></span><br><span class="line">always-show-logo no <span class="comment"># 开启 Redis 时不显示 logo</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>快照 SNAPSHOTTING<br>持久化：在规定的时间内，执行了多少次操作，会持久化到文件 .rdb、.aof。<br>redis 是内存数据库，如果没有持久化，那么数据断电即失。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># save 3600 1 # 表示如果 3600s 内，至少有 1 个 key 进行了修改，我们将进行持久化操作</span></span><br><span class="line"><span class="comment"># save 300 100 # 表示如果 300s 内，至少有 100 个 key 进行了修改，我们将进行持久化操作</span></span><br><span class="line"><span class="comment"># save 60 10000 # 表示如果 60s 内，如果至少有 10000 个 key 进行了修改，我们将进行持久化操作</span></span><br><span class="line"></span><br><span class="line">stop-writes-on-bgsave-error yes <span class="comment"># 持久化如果出错 redis 是否能继续工作</span></span><br><span class="line"></span><br><span class="line">rdbcompression yes <span class="comment"># 配置存储至本地数据库时，是否压缩 rdb 文件，需要消耗一些 cpu 资源</span></span><br><span class="line"></span><br><span class="line">rdbchecksum yes <span class="comment"># 是否校验 rdb 文件，会有一定的性能损耗</span></span><br><span class="line"></span><br><span class="line">dir ./ <span class="comment"># 数据库目录，数据库会写入这个目录，rdb、aof 文件也会写在这个目录</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>复制 REPLICATION （后续主从复制中进行解释）</p>
</blockquote>
<blockquote>
<p>安全 SECURITY</p>
</blockquote>
<p>设置 redis 的密码，默认是没有密码的。</p>
<ul>
<li><code>config get requirepass</code>：获取当前的用户名和密码</li>
<li><code>config set requirepass &quot;密码&quot;</code>：设置当前的密码</li>
<li><code>auth 密码</code>：使用密码登录<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@test1 ~]<span class="comment"># redis-cli -p 6379</span></span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line">127.0.0.1:6379&gt; config get requirepass</span><br><span class="line">1) <span class="string">&quot;requirepass&quot;</span></span><br><span class="line">2) <span class="string">&quot;&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; config <span class="built_in">set</span> requirepass <span class="string">&quot;123456&quot;</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; config get requirepass</span><br><span class="line">1) <span class="string">&quot;requirepass&quot;</span></span><br><span class="line">2) <span class="string">&quot;123456&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">exit</span></span><br><span class="line">[root@test1 ~]<span class="comment"># ps -ef|grep redis</span></span><br><span class="line">root       1844      1  0 15:54 ?        00:00:00 redis-server 127.0.0.1:6379</span><br><span class="line">root       1854   1611  0 15:56 pts/2    00:00:00 grep --color=auto redis</span><br><span class="line">[root@test1 ~]<span class="comment"># redis-cli -p 6379</span></span><br><span class="line">127.0.0.1:6379&gt; ping            <span class="comment"># 设置密码后再次连接时 ping 不通</span></span><br><span class="line">(error) NOAUTH Authentication required.</span><br><span class="line">127.0.0.1:6379&gt; auth 123456</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; ping <span class="comment"># 输入密码后可以 ping 桶</span></span><br><span class="line">PONG</span><br><span class="line">127.0.0.1:6379&gt; shutdown</span><br><span class="line">not connected&gt; <span class="built_in">exit</span></span><br><span class="line">[root@test1 ~]<span class="comment"># ps -ef|grep redis</span></span><br><span class="line">root       1857   1611  0 15:57 pts/2    00:00:00 grep --color=auto redis</span><br></pre></td></tr></table></figure>

</li>
</ul>
<blockquote>
<p>客户端 CLIENTS</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># maxclients 10000 # 设置最多能连上 redis 的客户端的数量</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>内存管理 MEMORY MANAGEMENT</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># maxmemory &lt;bytes&gt; # redis 最大内存容量</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># MAXMEMORY POLICY: how Redis will select what to remove when maxmemory</span></span><br><span class="line"><span class="comment"># is reached. You can select one from the following behaviors:</span></span><br><span class="line"><span class="comment"># 当达到最大容量限制后，可以选择如下操作</span></span><br><span class="line"><span class="comment"># 1. volatile-lru -&gt; Evict using approximated LRU, only keys with an expire set.（使用 lru 算法移除设置的过期时间的 key）</span></span><br><span class="line"><span class="comment"># 2. allkeys-lru -&gt; Evict any key using approximated LRU.（利用 lru 算法移除任意的 key）</span></span><br><span class="line"><span class="comment"># 3. volatile-lfu -&gt; Evict using approximated LFU, only keys with an expire set.（使用 lfu 算法移除设置的过期时间的 key）</span></span><br><span class="line"><span class="comment"># 4. allkeys-lfu -&gt; Evict any key using approximated LFU.（利用 lfu 算法移除任意的 key）</span></span><br><span class="line"><span class="comment"># 5. volatile-random -&gt; Remove a random key having an expire set.（随机移除设定了过期时间的 key）</span></span><br><span class="line"><span class="comment"># 6. allkeys-random -&gt; Remove a random key, any key.（随机移除任意 key）</span></span><br><span class="line"><span class="comment"># 7. volatile-ttl -&gt; Remove the key with the nearest expire time (minor TTL) （移除即将过期的 key）</span></span><br><span class="line"><span class="comment"># 8. noeviction -&gt; Don&#x27;t evict anything, just return an error on write operations.（不移除任何 key，仅返回一个写错误）</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># maxmemory-policy noeviction</span></span><br></pre></td></tr></table></figure>
<blockquote>
<p>APPEND ONLY MODE （aof 配置）</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">appendonly no <span class="comment"># 默认不开启 aof 模式，默认使用 rdb 方式持久化，大部分情况下 rdb 完全够用</span></span><br><span class="line"></span><br><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span> <span class="comment"># 持久化文件的名字</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># appendfsync always # 每次修改都会 sync，消耗性能</span></span><br><span class="line">appendfsync everysec <span class="comment"># 每秒执行一次 sync</span></span><br><span class="line"><span class="comment"># appendfsync no # 不执行 sync，这时操作系统会自己同步数据，速度最快</span></span><br></pre></td></tr></table></figure>

<h2 id="7-Redis-持久化（重点！！）"><a href="#7-Redis-持久化（重点！！）" class="headerlink" title="7 Redis 持久化（重点！！）"></a>7 Redis 持久化（重点！！）</h2><p>Redis 是内存数据库，如果不将内存中的数据库状态保存到磁盘，那么一旦服务器进程退出，服务器中的数据库也会消失，所以 Redis 提供了持久化功能。</p>
<h3 id="7-1-RDB（Redis-DataBase）"><a href="#7-1-RDB（Redis-DataBase）" class="headerlink" title="7.1 RDB（Redis DataBase）"></a>7.1 RDB（Redis DataBase）</h3><blockquote>
<p><strong>RDB（Redis DataBase）</strong></p>
</blockquote>
<p><img src="https://i.loli.net/2021/04/23/PMt67xdTgbeyk3h.png" alt="image.png"></p>
<p>在指定的时间间隔内将内存中的数据集快照写入磁盘，也就是 snapshot 快照，它恢复时将快照文件直接读入到内存里。</p>
<p>Redis 会单独创建（fork）一个子进程来进行持久化，会先将数据写入到一个临时文件中，待持久化过程都结束了，再利用这个临时文件替换上次持久化好的文件。整个过程中，主进程是不进行任何 IO 操作的，这就确保了极高的性能。如果需要进行大规模数据的恢复，且对于数据的完整性不是非常敏感，那 RDB 方式要比 AOF 方式更加的高效。RDB 的缺点是最后一次持久化后的数据可能丢失。我们默认的就是 RDB，一般情况下不需要修改这个配置。</p>
<p>有些时候在生产环境中我们会将这个文件进行备份。</p>
<p>rdb 保存的文件是 dump.rdb，都是在我们的配置文件的快照中进行配置的。<br><img src="https://i.loli.net/2021/04/23/Fiu8DqYRzrywnZe.png" alt="image.png"><br><img src="https://i.loli.net/2021/04/23/VmZGbXuB7hvidMK.png" alt="image.png"></p>
<blockquote>
<p>.rdb 文件的触发机制</p>
</blockquote>
<ol>
<li>save 的规则满足的情况下，会自动触发 rdb 规则</li>
<li>执行 flushall 命令，也会触发我们的 rdb 规则</li>
<li>退出（shutdown） redis，也会产生 rdb 文件</li>
</ol>
<p>备份就会自动生成一个 dump.rdb 文件。</p>
<blockquote>
<p>恢复 rdb 文件</p>
</blockquote>
<ol>
<li>只需将 rdb 文件放在我们 redis 启动的目录就可以，redis 启动的时候会自动检查 dump.rdb，恢复其中的数据。</li>
<li>查看 redis 启动的目录： <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; config get dir</span><br><span class="line">1) <span class="string">&quot;dir&quot;</span></span><br><span class="line">2) <span class="string">&quot;/usr/local/bin&quot;</span></span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><strong>rdb 备份的优点：</strong></p>
<ol>
<li>适合大规模数据的恢复</li>
<li>对数据的完整性要求不高</li>
</ol>
<p><strong>rdb 备份的缺点：</strong></p>
<ol>
<li>需要一定的时间间隔进行操作，如果 redis 意外宕机了，这个最后一次的修改数据就没有了。</li>
<li>fork 进程的时候，会占用一定的内存空间。</li>
</ol>
<h3 id="7-2-AOF（Append-Only-File）"><a href="#7-2-AOF（Append-Only-File）" class="headerlink" title="7.2 AOF（Append Only File）"></a>7.2 AOF（Append Only File）</h3><p>将我们所有的命令都记录下来，类似于 history 命令，恢复的时候就把这个文件全部都执行一遍。<br><img src="https://i.loli.net/2021/04/25/DdTH6tMYb9Kh1sC.png" alt="image.png"><br>以日志的形式来记录每个写操作，将 Redis 执行过的所有指令记录下来（读操作不记录），只追加文件但不可以改写文件，redis 启动之初会读取该文件重新构建数据，换言之，redis 重启的话就根据日志文件的内容将指令从前到后执行一次以完成数据的恢复工作。</p>
<blockquote>
<p>append</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">############################## APPEND ONLY MODE ###############################</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># By default Redis asynchronously dumps the dataset on disk. This mode is</span></span><br><span class="line"><span class="comment"># good enough in many applications, but an issue with the Redis process or</span></span><br><span class="line"><span class="comment"># a power outage may result into a few minutes of writes lost (depending on</span></span><br><span class="line"><span class="comment"># the configured save points).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The Append Only File is an alternative persistence mode that provides</span></span><br><span class="line"><span class="comment"># much better durability. For instance using the default data fsync policy</span></span><br><span class="line"><span class="comment"># (see later in the config file) Redis can lose just one second of writes in a</span></span><br><span class="line"><span class="comment"># dramatic event like a server power outage, or a single write if something</span></span><br><span class="line"><span class="comment"># wrong with the Redis process itself happens, but the operating system is</span></span><br><span class="line"><span class="comment"># still running correctly.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># AOF and RDB persistence can be enabled at the same time without problems.</span></span><br><span class="line"><span class="comment"># If the AOF is enabled on startup Redis will load the AOF, that is the file</span></span><br><span class="line"><span class="comment"># with the better durability guarantees.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Please check https://redis.io/topics/persistence for more information.</span></span><br><span class="line"></span><br><span class="line">appendonly no</span><br><span class="line"></span><br><span class="line"><span class="comment"># The name of the append only file (default: &quot;appendonly.aof&quot;)</span></span><br><span class="line"></span><br><span class="line">appendfilename <span class="string">&quot;appendonly.aof&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># The fsync() call tells the Operating System to actually write data on disk</span></span><br><span class="line"><span class="comment"># instead of waiting for more data in the output buffer. Some OS will really flush</span></span><br><span class="line"><span class="comment"># data on disk, some other OS will just try to do it ASAP.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Redis supports three different modes:</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># no: don&#x27;t fsync, just let the OS flush the data when it wants. Faster.</span></span><br><span class="line"><span class="comment"># always: fsync after every write to the append only log. Slow, Safest.</span></span><br><span class="line"><span class="comment"># everysec: fsync only one time every second. Compromise.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># The default is &quot;everysec&quot;, as that&#x27;s usually the right compromise between</span></span><br><span class="line"><span class="comment"># speed and data safety. It&#x27;s up to you to understand if you can relax this to</span></span><br><span class="line"><span class="comment"># &quot;no&quot; that will let the operating system flush the output buffer when</span></span><br><span class="line"><span class="comment"># it wants, for better performances (but if you can live with the idea of</span></span><br><span class="line"><span class="comment"># some data loss consider the default persistence mode that&#x27;s snapshotting),</span></span><br><span class="line"><span class="comment"># or on the contrary, use &quot;always&quot; that&#x27;s very slow but a bit safer than</span></span><br><span class="line"><span class="comment"># everysec.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># More details please check the following article:</span></span><br><span class="line"><span class="comment"># http://antirez.com/post/redis-persistence-demystified.html</span></span><br><span class="line"><span class="comment"># If unsure, use &quot;everysec&quot;.</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># appendfsync always</span></span><br><span class="line">appendfsync everysec</span><br><span class="line"><span class="comment"># appendfsync no</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># When the AOF fsync policy is set to always or everysec, and a background</span></span><br><span class="line"><span class="comment"># saving process (a background save or AOF log background rewriting) is</span></span><br><span class="line"><span class="comment"># performing a lot of I/O against the disk, in some Linux configurations</span></span><br><span class="line"><span class="comment"># Redis may block too long on the fsync() call. Note that there is no fix for</span></span><br><span class="line"><span class="comment"># this currently, as even performing fsync in a different thread will block</span></span><br><span class="line"><span class="comment"># our synchronous write(2) call.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># In order to mitigate this problem it&#x27;s possible to use the following option</span></span><br><span class="line"><span class="comment"># that will prevent fsync() from being called in the main process while a</span></span><br><span class="line"><span class="comment"># BGSAVE or BGREWRITEAOF is in progress.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This means that while another child is saving, the durability of Redis is</span></span><br><span class="line"><span class="comment"># the same as &quot;appendfsync none&quot;. In practical terms, this means that it is</span></span><br><span class="line"><span class="comment"># possible to lose up to 30 seconds of log in the worst scenario (with the</span></span><br><span class="line"><span class="comment"># default Linux settings).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># If you have latency problems turn this to &quot;yes&quot;. Otherwise leave it as</span></span><br><span class="line"><span class="comment"># If you have latency problems turn this to &quot;yes&quot;. Otherwise leave it as</span></span><br><span class="line"><span class="comment"># &quot;no&quot; that is the safest pick from the point of view of durability.</span></span><br><span class="line"></span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line"></span><br><span class="line"><span class="comment"># Automatic rewrite of the append only file.</span></span><br><span class="line"><span class="comment"># Redis is able to automatically rewrite the log file implicitly calling</span></span><br><span class="line"><span class="comment"># BGREWRITEAOF when the AOF log size grows by the specified percentage.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This is how it works: Redis remembers the size of the AOF file after the</span></span><br><span class="line"><span class="comment"># latest rewrite (if no rewrite has happened since the restart, the size of</span></span><br><span class="line"><span class="comment"># the AOF at startup is used).</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># This base size is compared to the current size. If the current size is</span></span><br><span class="line"><span class="comment"># bigger than the specified percentage, the rewrite is triggered. Also</span></span><br><span class="line"><span class="comment"># you need to specify a minimal size for the AOF file to be rewritten, this</span></span><br><span class="line"><span class="comment"># is useful to avoid rewriting the AOF file even if the percentage increase</span></span><br><span class="line"><span class="comment"># is reached but it is still pretty small.</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># Specify a percentage of zero in order to disable the automatic AOF</span></span><br><span class="line"><span class="comment"># rewrite feature.</span></span><br><span class="line"></span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ul>
<li>默认情况下，<code>appendonly</code> 命令是关闭的，如需开启需要手动进行配置，将其改为 <code>yes</code> 就可以，重启后就可以生效。（但是要想使 redis 的安装目录 /usr/local/bin 下有 appendonly.aof 文件，需要执行 <code>redis-cli config set appendonly yes</code> 命令，）</li>
<li>append的文件名字是 appendonly.aof 文件中，如果 aof 文件有问题，这时候 redis 是启动不起来的，需要修复这个文件才可以重启，redis 给我们提供了一个工具 <code>redis-check-aof --fix</code>，可以执行命令 <code>redis-check-aof --fix appendonly.aof</code>。（感觉这个文件像是将出问题后的内容删掉，只留下之前的部分）</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@test1 bin]# redis-check-aof --fix appendonly.aof </span><br><span class="line">0x              8d: Expected \r\n, got: 616a</span><br><span class="line">AOF analyzed: size=214, ok_up_to=133, diff=81</span><br><span class="line">This will shrink the AOF from 214 bytes, with 81 bytes, to 133 bytes</span><br><span class="line">Continue? [y/N]: y</span><br><span class="line">Successfully truncated AOF</span><br><span class="line">[root@test1 bin]# redis-server yyfconfig/redis.conf </span><br><span class="line">[root@test1 bin]# redis-cli -p 6379</span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line">&quot;v1&quot;</span><br><span class="line">127.0.0.1:6379&gt; get k4   # k4 应该是被删掉了</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure>
<blockquote>
<p>重写规则说明（了解即可）</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br></pre></td></tr></table></figure>

<p>aof 默认就是无限追加，文件就会越来越大，如果 aof 文件大于 64m，fork 一个新的进程来将我们的文件进行重写。</p>
<blockquote>
<p>优点和缺点</p>
</blockquote>
<p><strong>优点：</strong></p>
<ol>
<li>每一次修改都会同步，文件的完整性会更好</li>
<li>每秒同步一次，可能会丢失 1 秒的数据；当然 从不同步的情况下是效率最高的。</li>
</ol>
<p><strong>缺点：</strong></p>
<ol>
<li>相对于数据文件来说，aof 远远大于 rdb，修复的速度比 rdb 慢</li>
<li>aof 运行的效率也要比 rdb 慢，所以 redis 默认的配置就是 rdb 持久化</li>
</ol>
<p><strong>扩展：</strong></p>
<ol>
<li><p>rdb 持久化方式能够在指定的时间间隔内对数据进行快照存储。</p>
</li>
<li><p>aof 持久化记录每次对服务器的写操作，当服务器重启的时候会重新执行这些命令来恢复原始的数据，aof 命令以 reids 协议追加保存每次写操作到文件的末尾，redis 还能对 aof 文件进行后台重写，使得 aof 文件的体积不至于过大。</p>
</li>
<li><p><strong>只做缓存，如果只希望数据在服务器运行的时候存在，可以不做任何持久化。</strong></p>
</li>
<li><p>同时开启两种持久化方式。</p>
<ul>
<li>在这种情况下，当 redis 重启的时候会优先载入 aof 文件来恢复原始的数据，因为在通常情况下 aof 文件保存的数据集要比 rdb 文件保存的数据集要完整。</li>
<li>rdb 数据不实时，同时使用两者时服务器重启也只会找 aof 文件，那要不要只使用 aof 呢？建议不要，因为 rdb 更适合用于备份数据库（aof 在不断变化不好备份）。快速重启，不会有 aof 可能潜在的 bug，留着作为以防万一的手段。</li>
</ul>
</li>
<li><p>性能建议</p>
<ul>
<li>以为 rdb 文件只用作后备用途，建议只在 slave 上持久化 rdb 文件，而且只要 15 分钟 备份一次就好，只保留 <code>save 900 1</code> 这条规则</li>
<li>如果 enable aof，好处是在最恶劣的情况下也只会丢失不超过两秒数据，启动脚本较简单，只 load 自己的 aof 文件就可以，代价一是带来了持续的 IO，二是 aof rewrite 的最后将 rewrite 过程中产生的新数据写到新文件造成的阻塞几乎是不可避免的。只要硬盘许可，应该尽量减少 aof rewrite 的频率，aof 重写的基础大小默认值是 64M，太小了，可以设到 5G 以上，默认超过原大小 100%，重写可以改到适当的数值，</li>
<li>如果不 enable aof，仅靠 master-slave replication 实现高可用也可以，能省掉一大笔 IO，也减少了 rewrite 时带来的系统启动波动。代价是如果 Master/Slave 宕掉（断电），会丢失十几分钟的数据，启动脚本也要比较两个 Master/Slave 中的 rdb 文件，载入较新的一个。（微博使用这种架构） </li>
</ul>
</li>
</ol>
<h2 id="8-Redis-发布订阅"><a href="#8-Redis-发布订阅" class="headerlink" title="8 Redis 发布订阅"></a>8 Redis 发布订阅</h2><p>Redis 发布订阅（pub/sub）是一种消息通信模式：发送者（pub）发送消息，订阅者（sub）接收消息，例如：微信、微博、关注系统。</p>
<p>Redis 客户端可以订阅任意数量的频道。</p>
<p>订阅/发布消息图：（第一个：消息发送者，第二个：频道，第三个：消息订阅者）<br><img src="https://i.loli.net/2021/04/25/FZtpChAiuTRaYmG.png" alt="image.png">   </p>
<p>下图展示了频道 channel1，以及订阅这这个频道的三个客户端————client2、client5 和 client1 之间的关系：<br><img src="https://i.loli.net/2021/04/25/yX7OG5AsDrmewkF.png" alt="image.png"><br>当有新消息通过 PUBLISH 命令发送给频道 channel1 时，这个消息就会被发送给订阅它的三个客户端：<br><img src="https://i.loli.net/2021/04/25/Fw1cg8PlCL3tiWR.png" alt="image.png"></p>
<blockquote>
<p>发布订阅相关的命令：下述这些命令被广泛用于构建即时通信应用，比如网络聊天室（chatroom）和实时广播、实时提醒等。</p>
</blockquote>
<p><img src="https://i.loli.net/2021/04/25/qcR6WSdtl1LFvTN.png" alt="image.png"></p>
<p><strong>订阅端：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@test1 ~]<span class="comment"># redis-cli -p 6379</span></span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br><span class="line">127.0.0.1:6379&gt; subscribe kuangshenshuo</span><br><span class="line">Reading messages... (press Ctrl-C to quit)</span><br><span class="line">1) <span class="string">&quot;subscribe&quot;</span></span><br><span class="line">2) <span class="string">&quot;kuangshenshuo&quot;</span></span><br><span class="line">3) (<span class="built_in">integer</span>) 1</span><br><span class="line"><span class="comment">#############等待消息##############</span></span><br><span class="line">1) <span class="string">&quot;message&quot;</span></span><br><span class="line">2) <span class="string">&quot;kuangshenshuo&quot;</span></span><br><span class="line">3) <span class="string">&quot;hello,world&quot;</span></span><br><span class="line">1) <span class="string">&quot;message&quot;</span></span><br><span class="line">2) <span class="string">&quot;kuangshenshuo&quot;</span></span><br><span class="line">3) <span class="string">&quot;hello,redis&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><strong>发送端：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; publish kuangshenshuo <span class="string">&quot;hello,world&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br><span class="line">127.0.0.1:6379&gt; publish kuangshenshuo <span class="string">&quot;hello,redis&quot;</span></span><br><span class="line">(<span class="built_in">integer</span>) 1</span><br></pre></td></tr></table></figure>

<blockquote>
<p>原理</p>
</blockquote>
<p>Redis 是使用 C 实现的，通过分析 Redis 源码里的 pubsub.c 文件，了解发布和订阅机制的底层实现，借此加深对 Redis 的理解。</p>
<p>Redis 通过 PUBLISH、SUBSCRIBE 和 PSUBSCRIBE 等命令实现发布和订阅功能。</p>
<p>以微信公众号为例：<br>通过 SUBSCRIBE 命令订阅某频道后，redis-server 里维护了一个字典，字典的键就是一个个频道，而字典的值则是一个链表，链表中保存了所有订阅这个 channel 的客户端。SUBSCRIBE 命令的关键，就是将客户端添加到给定的 channel 的订阅链表中。<br><img src="https://i.loli.net/2021/04/25/EKsQoBLCG4jxRHm.png" alt="image.png"><br>通过 PUBLISH 命令向订阅者发送消息，redis-server 会使用给定的频道作为键，在它所维护的 channel 字典中查找记录了订阅这个频道的所有客户端的链表，遍历这个链表，将消息发布给所有订阅者。<br>Pub/Sub 从字面上理解就是发布（Publish）和订阅（Subscribe），在 Redis 中，你可以设定对某一个 key 值进行消息发布及消息订阅，当一个 key 值上进行了消息发布后，所有订阅它的客户端都会收到相应的消息。这一功能最明显的用法就是用作实时消息系统，比如：普通的即时聊天，群聊等功能。</p>
<p><strong>使用场景：</strong></p>
<ol>
<li>实时消息系统</li>
<li>实时聊天（频道当作聊天室，将消息回显给所有人即可）</li>
<li>订阅系统、关注系统<br>注：稍微复杂的系统就用消息中间件 MQ</li>
</ol>
<h2 id="9-主从复制"><a href="#9-主从复制" class="headerlink" title="9 主从复制"></a>9 主从复制</h2><h3 id="9-1-概念"><a href="#9-1-概念" class="headerlink" title="9.1 概念"></a>9.1 概念</h3><p>主从复制，是将一台 redis 服务器的数据，复制到其他的 redis 服务器。前者称为主节点（master/leader），后者称为从节点（slave/follower）；<strong>数据的复制是单向的，只能由主节点到从节点。</strong> Master 以写为主，Slave 以读为主。<br><strong>默认情况下，每台 redis 服务器都是主节点，</strong> 且一个主节点可以由多个从节点（或者没有从节点），但一个从节点只能有一个主节点。</p>
<p><strong>主从复制的作用主要包括：</strong></p>
<ol>
<li>数据冗余：主从复制实现了数据的热备份，是持久化之外的一种数据冗余方式。</li>
<li>故障恢复：当主节点出现问题时，可以由从节点提供服务，实现快速的故障恢复；实际上是一种服务的冗余。</li>
<li>负载均衡：在主从复制的基础上，配合读写分离，可以由主节点提供写服务，由从节点提供读服务（即写 Redis 数据时，应用连接主节点；读 Redis 数据时，应用连接从节点）分担服务器负载；尤其是在写少读多的场景下，通过多个从节点分担读负载，可以大大提高 Redis 服务器的并发量。</li>
<li>高可用（集群）基石：除了上述作用以外，主从复制还是哨兵和集群能够实施的基础，因此说主从复制是 Redis 高可用的基础。</li>
</ol>
<p>一般来说，要将 Redis 运用于工程项目中，只使用一台 Redis 是万万不能的（宕机），原因如下：</p>
<ol>
<li>从结构上，单个 Redis 服务器会发生单点故障，并且一台服务器需要处理所有的请求负载，压力较大；</li>
<li>从容量上，单个 Redis 服务器内存容量有限，就算一台 Redis 服务器内存容量为 256G，也不能将所有内存用作 Redis 存储内存，一般来说，<strong>单台 Redis 最大使用内存不应超过 20G。</strong></li>
</ol>
<p>电商网站上的商品，一般都是一次上传，无数次浏览，无数次浏览的，说专业点就是“多读少写”。<br>对于这种场景，我们可以使用如下这种架构：<br><img src="https://i.loli.net/2021/04/25/zIxSKhognMC3alp.png" alt="image.png"><br>主从复制，读写分离。80% 的情况下都是在进行读操作，减轻服务器的压力，架构中经常使用：一主二从。只要在公司中，主从复制就是必须要用的，因为在真实项目中不可能单机使用 redis。</p>
<h3 id="9-2-环境配置"><a href="#9-2-环境配置" class="headerlink" title="9.2 环境配置"></a>9.2 环境配置</h3><p>只配置从库，不用配置主库。</p>
<p>查看当前库的信息：</p>
<ul>
<li><code>info replication</code></li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info replication  <span class="comment"># 查看当前库的信息</span></span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master <span class="comment"># 角色</span></span><br><span class="line">connected_slaves:0 <span class="comment"># 没有从机</span></span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:d3da41a3815fb248f94aad6c2c6b8255b7af8cd0</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:0</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:0</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:0</span><br><span class="line">repl_backlog_histlen:0</span><br></pre></td></tr></table></figure>

<p><strong>复制 3 个配置文件，然后修改对应的配置信息：</strong></p>
<ol>
<li>端口</li>
<li>pid 名字</li>
<li>log 文件名字</li>
<li>dump.rdb 名字<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1. 复制 3 个配置文件，然后修改对应的信息</span></span><br><span class="line">[root@test1 bin]<span class="comment"># cd ./yyfconfig/</span></span><br><span class="line">[root@test1 yyfconfig]<span class="comment"># ls</span></span><br><span class="line">redis.conf</span><br><span class="line">[root@test1 yyfconfig]<span class="comment"># cp redis.conf redis79.conf</span></span><br><span class="line">[root@test1 yyfconfig]<span class="comment"># cp redis.conf redis80.conf</span></span><br><span class="line">[root@test1 yyfconfig]<span class="comment"># cp redis.conf redis81.conf</span></span><br><span class="line">[root@test1 yyfconfig]<span class="comment"># ls</span></span><br><span class="line">redis79.conf  redis80.conf  redis81.conf  redis.conf</span><br><span class="line">[root@test1 yyfconfig]<span class="comment"># vim redis79.conf </span></span><br><span class="line">[root@test1 yyfconfig]<span class="comment"># vim redis80.conf </span></span><br><span class="line">[root@test1 yyfconfig]<span class="comment"># vim redis81.conf </span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2. 修改对应的配置信息</span></span><br><span class="line"><span class="comment">#######################################################################</span></span><br><span class="line">logfile <span class="string">&quot;6379.log&quot;</span></span><br><span class="line">dbfilename dump6379.rdb</span><br><span class="line"></span><br><span class="line"><span class="comment">#######################################################################</span></span><br><span class="line">port 6380</span><br><span class="line">pidfile /var/run/redis_6380.pid</span><br><span class="line">logfile <span class="string">&quot;6380.log&quot;</span></span><br><span class="line">dbfilename dump6380.rdb</span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################################</span></span><br><span class="line">port 6381</span><br><span class="line">pidfile /var/run/redis_6381.pid</span><br><span class="line">logfile <span class="string">&quot;6381.log&quot;</span></span><br><span class="line">dbfilename dump6381.rdb</span><br></pre></td></tr></table></figure></li>
</ol>
<p><strong>修改完毕之后，启动我们的 3 个 redis 服务器，可以通过进程信息查看：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@test1 ~]<span class="comment"># ps -ef | grep redis</span></span><br><span class="line">root       1984      1  0 16:36 ?        00:00:00 redis-server 127.0.0.1:6379</span><br><span class="line">root       1998      1  0 16:37 ?        00:00:00 redis-server 127.0.0.1:6380</span><br><span class="line">root       2008      1  0 16:38 ?        00:00:00 redis-server 127.0.0.1:6381</span><br><span class="line">root       2014   1900  0 16:38 pts/5    00:00:00 grep --color=auto redis</span><br><span class="line">[root@test1 ~]<span class="comment"># </span></span><br></pre></td></tr></table></figure>
<h3 id="9-3-一主二从"><a href="#9-3-一主二从" class="headerlink" title="9.3 一主二从"></a>9.3 一主二从</h3><p><strong>默认情况下，每一台 Redis 服务器都是主节点。</strong>我们一般情况下只用配置从机就好了。<br>认老大，一主（79）二从（80，81）</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6380&gt; slaveof 127.0.0.1 6379   <span class="comment"># slaveof host 6379 找谁当自己的老大</span></span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave <span class="comment"># 当前角色是从机</span></span><br><span class="line">master_host:127.0.0.1  <span class="comment"># 可以看到主机的信息</span></span><br><span class="line">master_port:6379</span><br><span class="line">master_link_status:up</span><br><span class="line">master_last_io_seconds_ago:5</span><br><span class="line">master_sync_in_progress:0</span><br><span class="line">slave_repl_offset:14</span><br><span class="line">slave_priority:100</span><br><span class="line">slave_read_only:1</span><br><span class="line">replica_announced:1</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:3e76945a466390f2d0ea150bbdc76190dde83394</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:14</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:14</span><br><span class="line"></span><br><span class="line"><span class="comment">######################################################################################</span></span><br><span class="line"><span class="comment"># 在主机中查看</span></span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1  <span class="comment"># 多了从机的配置</span></span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=28,lag=0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:3e76945a466390f2d0ea150bbdc76190dde83394</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:42</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:42</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">##############################################################################</span></span><br><span class="line"><span class="comment"># 当两个从机都配完后，可以看到主机中会显示两个从机的信息</span></span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=378,lag=1</span><br><span class="line">slave1:ip=127.0.0.1,port=6381,state=online,offset=378,lag=1</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:3e76945a466390f2d0ea150bbdc76190dde83394</span><br><span class="line">master_replid2:0000000000000000000000000000000000000000</span><br><span class="line">master_repl_offset:378</span><br><span class="line">second_repl_offset:-1</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:378</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>真实的从主配置应该是在配置文件中配置，这样的话是永久的，我们这里使用的是命令，是暂时的。<br><img src="https://i.loli.net/2021/04/25/c1jGq4KmeavEhBC.png" alt="image.png"></p>
<blockquote>
<p>测试1：主机可以写，从机不能写只能读，主机中的所有信息和数据，都会自动被从机保存</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 主机</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k1 v1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k2 v2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k3 v3</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line"><span class="string">&quot;v1&quot;</span></span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) <span class="string">&quot;k1&quot;</span></span><br><span class="line">2) <span class="string">&quot;k3&quot;</span></span><br><span class="line">3) <span class="string">&quot;k2&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从机：80</span></span><br><span class="line">127.0.0.1:6380&gt; get k1</span><br><span class="line"><span class="string">&quot;v1&quot;</span></span><br><span class="line">127.0.0.1:6380&gt; keys *</span><br><span class="line">1) <span class="string">&quot;k1&quot;</span></span><br><span class="line">2) <span class="string">&quot;k2&quot;</span></span><br><span class="line">3) <span class="string">&quot;k3&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 从机：81</span></span><br><span class="line">127.0.0.1:6381&gt; get k2</span><br><span class="line"><span class="string">&quot;v2&quot;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<blockquote>
<p>测试2：主机断开连接，从机依旧连接到主机的，但是没有写操作，这个时候，主机如果回来了，从机依旧可以直接获取主机写的信息。<br>测试3：如果使用命令行，来配置从机，这时候如果重启 redis 服务，就会变回主机。但是只要变为主机，立马就会有主机中之前存的值。</p>
</blockquote>
<blockquote>
<p>复制原理：</p>
</blockquote>
<p>从机成功连接到主机后，会发送一个 sync 同步命令，主机接到命令，启动后台的存盘进程，同时收集所有用于修改数据集的命令，在后台进程执行完毕之后，<strong>主机将传送整个数据文件到从机，并完成一次同步。</strong></p>
<ul>
<li>全量复制：从机服务在接受到数据文件之后，将其存盘并加载到内存中。</li>
<li>增量复制：主机继续将新的所有收集到的修改命令依次传给从机，完成同步。</li>
</ul>
<p>但是只要是重新连接主机，一次完全同步（全量复制）将自动被执行，我们的数据一定可以再从机中看到。</p>
<blockquote>
<p>层层链路</p>
</blockquote>
<p>中间的即作为主机又作为从机。（这里要注意：使用 <code>info replication</code> 查看中间的角色依然为从机）<br><img src="https://i.loli.net/2021/04/26/2WhANLuRG13q9Pd.png" alt="image.png"><br>此时也可以完成主从复制。<br><strong>谋朝篡位</strong><br>但是，此时如果主机宕掉了，可以使用 <code>slaveof no one</code> 让自己变为主机，其他的节点就可以手动连接到最新的这个主节点（手动）。如果此时老大修复了，那就重新连接（手动）。</p>
<h3 id="9-4-哨兵模式"><a href="#9-4-哨兵模式" class="headerlink" title="9.4 哨兵模式"></a>9.4 哨兵模式</h3><p>（自动选择老大的模式）</p>
<blockquote>
<p>概述</p>
</blockquote>
<p>主从切换技术的方法：当主服务器宕机后，需要手动把一台从服务器切换为主服务器，这就需要人工干预，费事费力，还会造成一段时间服务不可用。这不是一种推荐的方式，更多时候，我们优先考虑哨兵模式。Redis 从 2.8 开始正式提供了 Sentinel （哨兵）架构来解决这个问题。</p>
<p>谋朝篡位的自动版，能够后台监控主机是否故障，如果故障了根据投票数<strong>自动将从库转换为主库。</strong></p>
<p>哨兵模式是一种特殊的模式，首先 Redis 提供了哨兵的命令，哨兵是一个独立的进程，作为进程，它会独立运行。其原理是<strong>哨兵通过发送命令，等待 redis 服务器响应，从而监控运行的多个 redis 实例。</strong></p>
<p><img src="https://i.loli.net/2021/04/26/yiJ5CWz4rRlm8XV.png" alt="image.png"></p>
<p>这里的哨兵有两个作用：</p>
<ul>
<li>通过发送命令，让 Redis 服务器返回监控其运行状态，包括主服务器和从服务器。</li>
<li>当哨兵监测到 master 宕机，会自动将 slave 切换成 master，然后通过<strong>发布订阅模式</strong>通知其他的从服务器，修改配置文件，让它们切换主机。</li>
</ul>
<p>然而一个哨兵进程对 redis 服务器进行监控，可能会出现问题，为此，我们可以使用多个哨兵进行监控。各个哨兵之间还会进行监控，这样就形成了多哨兵模式。<br><img src="https://i.loli.net/2021/04/26/dpxraqhWR5HmwBi.png" alt="image.png"><br>对于上面这种情况，假设主服务器宕机，哨兵 1 先检测到这个结果，系统并不会马上进行 failover 过程，仅仅是哨兵 1 主观的认为主服务器不可用，这个现象称为<strong>主观下线</strong>。当后面的哨兵也检测到主服务器不可用，并且数量达到一定值时，那么哨兵之间就会进行一次投票，投票的结果由一个哨兵发起，进行 failover 【故障转移】操作。切换成功后，就会发布订阅模式，让各个哨兵把自己监控的从服务器实现切换主机，这个过程称为<strong>客观下线</strong>。</p>
<blockquote>
<p>测试（目前的状态是：一主二从）</p>
</blockquote>
<ol>
<li>配置哨兵配置文件 sentinel.conf</li>
</ol>
<ul>
<li>命令格式：<code>monitor 被监控的名称 host port 1</code>（后面这个数字 1 代表：主机挂了，slave 投票看让谁接替成为主机，票数最多的，就会成为主机。）<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@test1 yyfconfig]<span class="comment"># vi sentinel.conf</span></span><br><span class="line">[root@test1 yyfconfig]<span class="comment"># cat sentinel.conf </span></span><br><span class="line">sentinel monitor myredis 127.0.0.1 6379 1</span><br></pre></td></tr></table></figure></li>
</ul>
<ol start="2">
<li>启动哨兵：</li>
</ol>
<ul>
<li>启动命令：<code>redis-sentinel sentinel的配置文件</code><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">[root@test1 bin]<span class="comment"># redis-sentinel yyfconfig/sentinel.conf </span></span><br><span class="line">1717:X 26 Apr 2021 10:51:19.036 <span class="comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span><br><span class="line">1717:X 26 Apr 2021 10:51:19.036 <span class="comment"># Redis version=6.2.2, bits=64, commit=00000000, modified=0, pid=1717, just started</span></span><br><span class="line">1717:X 26 Apr 2021 10:51:19.036 <span class="comment"># Configuration loaded</span></span><br><span class="line">1717:X 26 Apr 2021 10:51:19.036 * Increased maximum number of open files to 10032 (it was originally <span class="built_in">set</span> to 1024).</span><br><span class="line">1717:X 26 Apr 2021 10:51:19.036 * monotonic clock: POSIX clock_gettime</span><br><span class="line">                _._                                                  </span><br><span class="line">           _.-``__ <span class="string">&#x27;&#x27;</span>-._                                             </span><br><span class="line">      _.-``    `.  `_.  <span class="string">&#x27;&#x27;</span>-._           Redis 6.2.2 (00000000/0) 64 bit</span><br><span class="line">  .-`` .-```.  ```\/    _.,_ <span class="string">&#x27;&#x27;</span>-._                                  </span><br><span class="line"> (    <span class="string">&#x27;      ,       .-`  | `,    )     Running in sentinel mode</span></span><br><span class="line"><span class="string"> |`-._`-...-` __...-.``-._|&#x27;</span>` _.-<span class="string">&#x27;|     Port: 26379</span></span><br><span class="line"><span class="string"> |    `-._   `._    /     _.-&#x27;</span>    |     PID: 1717</span><br><span class="line">  `-._    `-._  `-./  _.-<span class="string">&#x27;    _.-&#x27;</span>                                   </span><br><span class="line"> |`-._`-._    `-.__.-<span class="string">&#x27;    _.-&#x27;</span>_.-<span class="string">&#x27;|                                  </span></span><br><span class="line"><span class="string"> |    `-._`-._        _.-&#x27;</span>_.-<span class="string">&#x27;    |           https://redis.io       </span></span><br><span class="line"><span class="string">  `-._    `-._`-.__.-&#x27;</span>_.-<span class="string">&#x27;    _.-&#x27;</span>                                   </span><br><span class="line"> |`-._`-._    `-.__.-<span class="string">&#x27;    _.-&#x27;</span>_.-<span class="string">&#x27;|                                  </span></span><br><span class="line"><span class="string"> |    `-._`-._        _.-&#x27;</span>_.-<span class="string">&#x27;    |                                  </span></span><br><span class="line"><span class="string">  `-._    `-._`-.__.-&#x27;</span>_.-<span class="string">&#x27;    _.-&#x27;</span>                                   </span><br><span class="line">      `-._    `-.__.-<span class="string">&#x27;    _.-&#x27;</span>                                       </span><br><span class="line">          `-._        _.-<span class="string">&#x27;                                           </span></span><br><span class="line"><span class="string">              `-.__.-&#x27;</span>                                               </span><br><span class="line"></span><br><span class="line">1717:X 26 Apr 2021 10:51:19.038 <span class="comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></span><br><span class="line">1717:X 26 Apr 2021 10:51:19.042 <span class="comment"># Sentinel ID is b12412cc0a940d58eecee0221e43b780d3e66b43</span></span><br><span class="line">1717:X 26 Apr 2021 10:51:19.042 <span class="comment"># +monitor master myredis 127.0.0.1 6379 quorum 1</span></span><br><span class="line">1717:X 26 Apr 2021 10:51:19.049 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ myredis 127.0.0.1 6379</span><br><span class="line">1717:X 26 Apr 2021 10:51:19.055 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ myredis 127.0.0.1 6379</span><br><span class="line"></span><br></pre></td></tr></table></figure>

</li>
</ul>
<blockquote>
<p>如果 master 节点断开了，这时候就会从 slave 中随机选择一个服务器。（选择服务器时使用投票算法）</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 81 原来是从机，这里变为了主机</span></span><br><span class="line">127.0.0.1:6381&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip=127.0.0.1,port=6380,state=online,offset=22184,lag=0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:969372173458c9e8599fc1741eb10801e7db4840</span><br><span class="line">master_replid2:cb3f754d187d49b0ab565cc263b6a1ffeb44d0f4</span><br><span class="line">master_repl_offset:22184</span><br><span class="line">second_repl_offset:14880</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:1</span><br><span class="line">repl_backlog_histlen:22184</span><br></pre></td></tr></table></figure>
<p>哨兵端的信息如下：<br><img src="https://i.loli.net/2021/04/26/1XohJvDHYaIurki.png" alt="image.png"></p>
<blockquote>
<p>如果主机回来了，只能归并到新的主机下，作为从机，这就是哨兵模式的规则。</p>
</blockquote>
<p><img src="https://i.loli.net/2021/04/26/zWGJmus7f3AZFBT.png" alt="image.png"></p>
<blockquote>
<p>哨兵模式</p>
</blockquote>
<p><strong>优点：</strong></p>
<ol>
<li>哨兵集群，基于主从复制模式，所有主从配置优点，他全都有</li>
<li>主从可以切换，故障可以转移，系统的可用性就会更好</li>
<li>哨兵模式就是主从模式的升级，手动到自动，更加健壮</li>
</ol>
<p><strong>缺点：</strong></p>
<ol>
<li>Redis 不好在线扩容，集群容量一旦达到上限，在线扩容就十分麻烦</li>
<li>实现哨兵模式的配置其实很麻烦，里面有很多选择</li>
</ol>
<blockquote>
<p>哨兵模式的全部配置</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Example sentinel.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 哨兵 sentinel 实例运行的端口 默认 26379</span></span><br><span class="line">port 26379</span><br><span class="line"></span><br><span class="line"><span class="comment"># 哨兵 sentinel 的工作目录</span></span><br><span class="line">dir /tmp</span><br><span class="line"></span><br><span class="line"><span class="comment"># 哨兵 sentinel 监控的 redis 主节点的 ip port</span></span><br><span class="line"><span class="comment"># master-name 可以自己命名的主节点名字，只能由字母、数字以及&quot;.-_&quot;这三个字符组成</span></span><br><span class="line"><span class="comment"># quorum 配置多少个 sentinel 哨兵统一认为 master 主节点失联，那么这是客观上认为主节点失联了</span></span><br><span class="line"><span class="comment"># sentinel monitor &lt;master-name&gt; &lt;ip&gt; &lt;redis-port&gt; &lt;quorum&gt;</span></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2</span><br><span class="line"></span><br><span class="line"><span class="comment"># 当在 Redis 实例中开启了 requirepass foobared 授权密码，这样所有连接 Redis 实例的客户端都需要提供密码</span></span><br><span class="line"><span class="comment"># 设置哨兵 sentinel 连接主从的密码 注意必须为主从设置一样的验证码</span></span><br><span class="line"><span class="comment"># sentinel auth-pass &lt;master-name&gt; &lt;password&gt;</span></span><br><span class="line">sentinel auth-pass mymaster MYSECURE--secret-0123password</span><br><span class="line"></span><br><span class="line"><span class="comment"># 指定多少毫秒之后，主节点没有应答哨兵 sentinel，此时，哨兵主观上认为主节点下线。（默认 30 秒）</span></span><br><span class="line"><span class="comment"># sentinel down-after-milliseconds &lt;master-name&gt; &lt;milliseconds&gt;</span></span><br><span class="line">sentinel down-after-millisenonds mymaster 30000</span><br><span class="line"></span><br><span class="line"><span class="comment"># 这个配置项指定了在发生 failover（故障转移） 设备切换时最多可以有多少个 slave 同时对新的 master 进行同步</span></span><br><span class="line"><span class="comment"># 这个数字越小，完成 failover 所需的时间就越长，但是如果这个数字越大，就意味着越多的 slave 因为 replication 而不可用，可以通过将这个值设为 1 来保证每次只有一个 slave 处于不能处理命令请求的状态</span></span><br><span class="line"><span class="comment"># sentinel parallel-syncs &lt;master-name&gt; &lt;numslaves&gt;</span></span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line"></span><br><span class="line"><span class="comment"># 故障转移的超时时间 failover-timeout 可以用在以下这些方面</span></span><br><span class="line"><span class="comment"># 1. 同一个 sentinel 对同一个 master 两次 failover 之间的时间间隔</span></span><br><span class="line"><span class="comment"># 2. 当一个 slave 从一个错误的 master 那里同步数据开始计算时间，直到 slave 被纠正为正确的 master 那里同步数据时。</span></span><br><span class="line"><span class="comment"># 3. 当想要取消一个正在进行的 failover 所需要的时间</span></span><br><span class="line"><span class="comment"># 4. 当进行 failover 时，配置所有 slaves 指向新的 master 所需的最大时间。不过，即使过了最大时间，slaves 依然会被正确配置为指向 master，但是就不按 parallel-syncs 所配置的规则来了</span></span><br><span class="line"><span class="comment"># 默认三分钟</span></span><br><span class="line"><span class="comment"># sentinel failover-timeout &lt;master-name&gt; &lt;milliseconds&gt;</span></span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line"></span><br><span class="line"><span class="comment"># SCRIPTS EXECUTION</span></span><br><span class="line"><span class="comment"># 配置当某一事件发生时所需要执行的脚本，可以通过脚本来通知管理员，例如当系统运行不正常时发邮件通知相关人员</span></span><br><span class="line"><span class="comment"># 对于脚本的运行结果有以下规则：</span></span><br><span class="line"><span class="comment"># 若脚本执行后返回 1，那么该脚本稍后将会被再次执行，重复次数目前默认为 10</span></span><br><span class="line"><span class="comment"># 若脚本执行后返回 2，或者比 2 更高的一个返回值，脚本将不会重复执行</span></span><br><span class="line"><span class="comment"># 如果脚本在执行过程中，由于收到系统中断信号被终止了，则同返回值为 1 时的行为相同</span></span><br><span class="line"><span class="comment"># 一个脚本的最大执行时间为 60s，如果超过这个时间，脚本将会被一个 SIGKILL 信号终止，之后重新执行</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通知型脚本：当 sentinel 有任何警告级别的事件发生时（比如说 redis 实例的主观失效和客观失效等等），将会失去调用这个脚本，这时这个脚本应该通过该邮件、SMS 等方式去通知系统管理员关于系统不正常运行的信息。调用该脚本时，将传给脚本两个参数，一个是事件的类型，一个是事件的描述。如果 sentinel.conf 配置文件中配置了这个脚本路径，那么必须保证这个脚本存在于这个路径，并且是可执行的，否则 sentinel 无法正常启动成功。</span></span><br><span class="line"><span class="comment"># 通知脚本</span></span><br><span class="line"><span class="comment"># shell 编程</span></span><br><span class="line"><span class="comment"># sentinel notification-script &lt;master-name&gt; &lt;script-path&gt;</span></span><br><span class="line">sentinel notification-script mymaster /var/redis/notify.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 客户端重新配置主节点参数脚本</span></span><br><span class="line"><span class="comment"># 当一个 master 由于 failover 而发生改变时，这个脚本将会被调用，通知相关的客户端关于 master 地址已经发生改变的信息。</span></span><br><span class="line"><span class="comment"># 以下参数将会在调用脚本时传给脚本：</span></span><br><span class="line"><span class="comment"># &lt;master-name&gt; &lt;role&gt; &lt;state&gt; &lt;from-ip&gt; &lt;from-port&gt; &lt;to-ip&gt; &lt;to-port&gt;</span></span><br><span class="line"><span class="comment"># 目前 &lt;state&gt; 总是 &quot;failover&quot;</span></span><br><span class="line"><span class="comment"># &lt;role&gt; 是 &quot;leader&quot; 或者 &quot;observer&quot; 中的一个</span></span><br><span class="line"><span class="comment"># 参数 from-ip、form-port、to-ip、to-port 是旧的 master 和 新的 master（即旧的 slave）进行通信的</span></span><br><span class="line"><span class="comment"># 这个脚本应该是通用的，能被多次调用，不是针对性的</span></span><br><span class="line"><span class="comment"># sentinel client-reconfig-script &lt;master-name&gt; &lt;script-path&gt;</span></span><br><span class="line">sentinel client-reconfig-script mymaster /var/redis/reconfig.sh <span class="comment"># 一般都是由运维来配置</span></span><br></pre></td></tr></table></figure>

<h2 id="10-Redis-缓存穿透和雪崩（面试高频。工作常用）"><a href="#10-Redis-缓存穿透和雪崩（面试高频。工作常用）" class="headerlink" title="10 Redis 缓存穿透和雪崩（面试高频。工作常用）"></a>10 Redis 缓存穿透和雪崩（面试高频。工作常用）</h2><blockquote>
<p>服务的高可用问题</p>
</blockquote>
<p>这里不会详细的分析解决方案的底层。</p>
<p>Redis 缓存的使用，极大的提升了应用程序的性能和效率，特别是数据查询方面。但同时，它也带来了一些问题。其中，最要害的问题，就是数据一致性问题，从严格意义上讲，这个问题无解。如果对数据的一致性要求很高，那么就不能使用缓存。</p>
<p>另外，一些典型的问题就是，缓存穿透、缓存雪崩和缓存击穿。目前，业界也都有比较流行的解决方案。<br><img src="https://i.loli.net/2021/04/26/VN4Blt3hCLaKPmv.png" alt="image.png"></p>
<h3 id="10-1-缓存穿透（查不到）"><a href="#10-1-缓存穿透（查不到）" class="headerlink" title="10.1 缓存穿透（查不到）"></a>10.1 缓存穿透（查不到）</h3><blockquote>
<p>概念</p>
</blockquote>
<p>用户想要查询一个数据，发现 redis 内存数据库没有，也就是缓存没有命中，于是向持久层数据库查询。发现也没有，于是本次查询失败。当用户很多的时候，缓存中都没有命中（例如：秒杀！），于是都去请求了持久层数据库。这会给持久层数据库造成很大的压力，这时候就相当于出现了缓存穿透。</p>
<blockquote>
<p>解决方案</p>
</blockquote>
<p><strong>布隆过滤器：</strong><br>一种数据结构，对所有可能查询的参数以 hash 形式存储，在控制层先进行校验，不符合则丢弃，从而避免了对底层存储系统的压力。<br><img src="https://i.loli.net/2021/04/26/rDl7EjiHf83G9TZ.png" alt="image.png"></p>
<p><strong>缓存空对象：</strong><br>当存储不命中后，即使返回空对象也将其缓存起来，同时会设置一个过期时间，之后再访问这个数据库将会从缓存中获取，保护了后端数据。<br><img src="https://i.loli.net/2021/04/26/EXezYsmndO63chR.png" alt="image.png"></p>
<p>但这种方法会存在两个问题：</p>
<ol>
<li>如果空值能够被缓存起来，这就意味着缓存需要更多的空间存储更多的键，因为这当中可能会有很多的空值的键；</li>
<li>即使对空值设置了过期时间，还是会存在缓存层和存储层的数据会有一段时间窗口的不一致，这对于需要保持一致性的业务会有影响。</li>
</ol>
<h3 id="10-2-缓存击穿（量太大，缓存过期）"><a href="#10-2-缓存击穿（量太大，缓存过期）" class="headerlink" title="10.2 缓存击穿（量太大，缓存过期）"></a>10.2 缓存击穿（量太大，缓存过期）</h3><blockquote>
<p>概念</p>
</blockquote>
<p>这里需要注意和缓存穿透的区别，缓存击穿，是指一个 key 非常热点，在不停的扛着大并发，大并发集中对这一个点进行访问，当这个 key 在失效的瞬间，持续的大并发就穿破缓存，直接请求数据库，就像在一个屏障上凿开了一个洞。</p>
<p>当某个 key 在过期的瞬间，有大量的请求并发访问，这类数据一般是热点数据，由于缓存过期，会同时访问数据库来查询最新数据，并且回写缓存，会导致使数据库瞬间压力过大。</p>
<blockquote>
<p>解决方案</p>
</blockquote>
<p><strong>设置热点数据永不过期</strong><br>从缓存层来看，没有设置过期时间，所以不会出现热点 key 过期后产生的问题。</p>
<p><strong>加互斥锁：</strong><br>分布式锁：使用分布式锁，保证对于每个 key 同时只有一个线程去查询后端服务，其他线程没有获得分布式锁的权限，因此只需要等待即可。这种方式将高并发的压力转移到了分布式锁，因此对分布式锁的考验很大。<br><img src="https://i.loli.net/2021/04/26/sDvWVMuSP3L5TFZ.png" alt="image.png"></p>
<h3 id="10-3-缓存雪崩"><a href="#10-3-缓存雪崩" class="headerlink" title="10.3 缓存雪崩"></a>10.3 缓存雪崩</h3><blockquote>
<p>概念</p>
</blockquote>
<p>缓存雪崩，是指在某一个时间段，缓存集中过期失效。Redis 宕机。<br>产生雪崩的原因之一，比如在写本文的时候，马上就要到双十二零点，很快就会迎来一波抢购，这波商品时间比较集中的放入了缓存，假设缓存一个小时，那么到了凌晨一点钟的时候，这批商品的缓存就都过期了。而对这批商品的访问查询，都落到了数据库上，对于数据库而言，就会产生周期性的压力波峰。于是所有的请求都会达到存储层，存储层的调用量会暴增，造成存储层也会挂掉的情况。<br><img src="https://i.loli.net/2021/04/26/Bb6f9d2VUiXG8Ar.png" alt="image.png"></p>
<p>其实，集中过期，倒不是非常致命，比较致命的缓存雪崩，是缓存服务器某个节点宕机或断网。因为自然形成的缓存雪崩，一定是在某个时间段集中创建缓存，这个时候，数据库也是可以顶住压力的。无非就是对数据库产生周期性的压力而已。而缓存服务节点的宕机，对于数据库服务器造成的压力是不可预知的，很有可能瞬间就把数据库压垮。</p>
<blockquote>
<p>解决方案</p>
</blockquote>
<p><strong>redis 高可用：</strong><br>这个思想的含义是，既然 redis 有可能挂掉，那我多增设几台 redis，这样一台挂掉之后，其他的还可以继续工作，其实就是搭建集群。（异地多活）</p>
<p><strong>降流降级：</strong><br>思想：在缓存失效后，通过加锁或者队列来控制读数据库写缓存的线程数量。比如对某个 key 只允许一个线程查询数据和写缓存，其他线程等待。</p>
<p><strong>数据预热：</strong><br>数据加热的含义就是在正式部署之前，先把可能的数据预先访问一遍，这样部分可能大量访问的数据就会加载到缓存中。在即将发生大并发访问前手动触发加载缓存不同的 key，设置不同的过期时间，让缓存失效的时间点尽量均匀。</p>

    </div>

    
    
    

      <div>
        
          <div>
    
        <div style="text-align:center;color: #ccc;font-size:14px;">-------------本文结束<i class="fa fa-paw"></i>感谢您的阅读-------------</div>
    
</div>

        
      </div>
        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>Crystal
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://crystal1213.github.io/posts/3135569683/" title="Redis">https://crystal1213.github.io/posts/3135569683/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>


      


      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/posts/166114572/" rel="prev" title="Docker进阶篇">
      <i class="fa fa-chevron-left"></i> Docker进阶篇
    </a></div>
      <div class="post-nav-item"></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-Nosql-%E6%A6%82%E8%BF%B0"><span class="nav-number">1.</span> <span class="nav-text">1 Nosql 概述</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-%E4%B8%BA%E4%BB%80%E4%B9%88%E8%A6%81%E7%94%A8-Nosql"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 为什么要用 Nosql</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-%E4%BB%80%E4%B9%88%E6%98%AF-NoSQL"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 什么是 NoSQL</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-3-%E9%98%BF%E9%87%8C%E5%B7%B4%E5%B7%B4%E6%BC%94%E8%BF%9B%E5%88%86%E6%9E%90"><span class="nav-number">1.3.</span> <span class="nav-text">1.3 阿里巴巴演进分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-4-NoSQL-%E5%9B%9B%E5%A4%A7%E5%88%86%E7%B1%BB"><span class="nav-number">1.4.</span> <span class="nav-text">1.4 NoSQL 四大分类</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Redis-%E5%85%A5%E9%97%A8"><span class="nav-number">2.</span> <span class="nav-text">2 Redis 入门</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#2-1-%E6%A6%82%E8%BF%B0"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-2-Linux-%E5%AE%89%E8%A3%85"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 Linux 安装</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-3-%E6%B5%8B%E8%AF%95%E6%80%A7%E8%83%BD"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 测试性能</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#2-4-%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86"><span class="nav-number">2.4.</span> <span class="nav-text">2.4 基础知识</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E4%BA%94%E5%A4%A7%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">3.</span> <span class="nav-text">3 五大数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#3-1-Redis-Key"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 Redis-Key</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-2-string%EF%BC%88%E5%AD%97%E7%AC%A6%E4%B8%B2%EF%BC%89"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 string（字符串）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-3-List%EF%BC%88%E5%88%97%E8%A1%A8%EF%BC%89"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 List（列表）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-4-Set%EF%BC%88%E9%9B%86%E5%90%88%EF%BC%89"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 Set（集合）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-5-Hash%EF%BC%88%E5%93%88%E5%B8%8C%EF%BC%89"><span class="nav-number">3.5.</span> <span class="nav-text">3.5 Hash（哈希）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#3-6-Zset%EF%BC%88%E6%9C%89%E5%BA%8F%E9%9B%86%E5%90%88%EF%BC%89"><span class="nav-number">3.6.</span> <span class="nav-text">3.6 Zset（有序集合）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-%E4%B8%89%E7%A7%8D%E7%89%B9%E6%AE%8A%E7%9A%84%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B"><span class="nav-number">4.</span> <span class="nav-text">4 三种特殊的数据类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-Geospatial-%EF%BC%88%E5%9C%B0%E7%90%86%E4%BD%8D%E7%BD%AE%EF%BC%89"><span class="nav-number">4.1.</span> <span class="nav-text">4.1 Geospatial （地理位置）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-Hyperloglog"><span class="nav-number">4.2.</span> <span class="nav-text">4.2 Hyperloglog</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-bitmap%EF%BC%88%E4%BD%8D%E5%9B%BE%EF%BC%89"><span class="nav-number">4.3.</span> <span class="nav-text">4.3 bitmap（位图）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#5-%E4%BA%8B%E5%8A%A1"><span class="nav-number">5.</span> <span class="nav-text">5 事务</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#6-Redis-conf-%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="nav-number">6.</span> <span class="nav-text">6 Redis.conf 配置文件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#7-Redis-%E6%8C%81%E4%B9%85%E5%8C%96%EF%BC%88%E9%87%8D%E7%82%B9%EF%BC%81%EF%BC%81%EF%BC%89"><span class="nav-number">7.</span> <span class="nav-text">7 Redis 持久化（重点！！）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#7-1-RDB%EF%BC%88Redis-DataBase%EF%BC%89"><span class="nav-number">7.1.</span> <span class="nav-text">7.1 RDB（Redis DataBase）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#7-2-AOF%EF%BC%88Append-Only-File%EF%BC%89"><span class="nav-number">7.2.</span> <span class="nav-text">7.2 AOF（Append Only File）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#8-Redis-%E5%8F%91%E5%B8%83%E8%AE%A2%E9%98%85"><span class="nav-number">8.</span> <span class="nav-text">8 Redis 发布订阅</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#9-%E4%B8%BB%E4%BB%8E%E5%A4%8D%E5%88%B6"><span class="nav-number">9.</span> <span class="nav-text">9 主从复制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#9-1-%E6%A6%82%E5%BF%B5"><span class="nav-number">9.1.</span> <span class="nav-text">9.1 概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-2-%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="nav-number">9.2.</span> <span class="nav-text">9.2 环境配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-3-%E4%B8%80%E4%B8%BB%E4%BA%8C%E4%BB%8E"><span class="nav-number">9.3.</span> <span class="nav-text">9.3 一主二从</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#9-4-%E5%93%A8%E5%85%B5%E6%A8%A1%E5%BC%8F"><span class="nav-number">9.4.</span> <span class="nav-text">9.4 哨兵模式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#10-Redis-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E5%92%8C%E9%9B%AA%E5%B4%A9%EF%BC%88%E9%9D%A2%E8%AF%95%E9%AB%98%E9%A2%91%E3%80%82%E5%B7%A5%E4%BD%9C%E5%B8%B8%E7%94%A8%EF%BC%89"><span class="nav-number">10.</span> <span class="nav-text">10 Redis 缓存穿透和雪崩（面试高频。工作常用）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#10-1-%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%EF%BC%88%E6%9F%A5%E4%B8%8D%E5%88%B0%EF%BC%89"><span class="nav-number">10.1.</span> <span class="nav-text">10.1 缓存穿透（查不到）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-2-%E7%BC%93%E5%AD%98%E5%87%BB%E7%A9%BF%EF%BC%88%E9%87%8F%E5%A4%AA%E5%A4%A7%EF%BC%8C%E7%BC%93%E5%AD%98%E8%BF%87%E6%9C%9F%EF%BC%89"><span class="nav-number">10.2.</span> <span class="nav-text">10.2 缓存击穿（量太大，缓存过期）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#10-3-%E7%BC%93%E5%AD%98%E9%9B%AA%E5%B4%A9"><span class="nav-number">10.3.</span> <span class="nav-text">10.3 缓存雪崩</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Crystal"
      src="/images/head.gif">
  <p class="site-author-name" itemprop="name">Crystal</p>
  <div class="site-description" itemprop="description">Guard heart, everything flows from it.</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">23</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">5</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Crystal1213" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Crystal1213" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://crystal.blog.csdn.net/" title="CSDN → https:&#x2F;&#x2F;crystal.blog.csdn.net&#x2F;" rel="noopener" target="_blank"><i class="fa fa-copyright fa-fw"></i>CSDN</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://leetcode-cn.com/u/crystal_yyf/" title="LeetCode → https:&#x2F;&#x2F;leetcode-cn.com&#x2F;u&#x2F;crystal_yyf&#x2F;" rel="noopener" target="_blank"><i class="fa fa-code fa-fw"></i>LeetCode</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://weibo.com/GodLoveCrystal" title="Weibo → https:&#x2F;&#x2F;weibo.com&#x2F;GodLoveCrystal" rel="noopener" target="_blank"><i class="fab fa-weibo fa-fw"></i>Weibo</a>
      </span>
  </div>
  <div class="cc-license motion-element" itemprop="license">
    <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" rel="noopener" target="_blank"><img src="/images/cc-by-nc-sa.svg" alt="Creative Commons"></a>
  </div>



      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2020 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Crystal</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">235k</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>
